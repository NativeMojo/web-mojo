<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>View Basics Test - MOJO Framework</title>
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
            rel="stylesheet"
        />
        <style>
            .parent-view {
                background-color: #e3f2fd;
                padding: 15px;
                border: 2px solid #2196f3;
                border-radius: 4px;
                margin-bottom: 10px;
            }
            .child-view {
                background-color: #fff3e0;
                padding: 10px;
                border: 2px solid #ff9800;
                border-radius: 4px;
                margin: 10px 0;
            }
            .model-view {
                background-color: #e8f5e9;
                padding: 15px;
                border: 2px solid #4caf50;
                border-radius: 4px;
            }
            .console-log {
                background-color: #263238;
                color: #aed581;
                padding: 10px;
                font-family: monospace;
                font-size: 12px;
                max-height: 400px;
                overflow-y: auto;
                border-radius: 4px;
            }
            .log-info {
                color: #64b5f6;
            }
            .log-success {
                color: #81c784;
            }
            .log-warning {
                color: #ffb74d;
            }
            .log-pipe {
                color: #ba68c8;
            }
            .pipe-demo {
                background: #f5f5f5;
                padding: 8px;
                border-left: 3px solid #9c27b0;
                margin: 5px 0;
            }
        </style>
    </head>
    <body>
        <div class="container mt-4">
            <h1>View Basics Test with Pipes</h1>
            <p class="lead">
                Testing View class features with unified data access and pipe formatting
            </p>

            <div class="row">
                <div class="col-md-7">
                    <h3>Test 1: Basic View with Pipes</h3>
                    <div id="basic-view"></div>

                    <h3 class="mt-4">Test 2: Parent-Child with Pipes</h3>
                    <div id="parent-view"></div>

                    <h3 class="mt-4">Test 3: Model Binding with Pipes</h3>
                    <div id="model-view"></div>
                    <div class="mt-2">
                        <button id="update-model" class="btn btn-sm btn-primary">
                            Update Model
                        </button>
                        <button id="add-item" class="btn btn-sm btn-success">Add Item</button>
                        <button id="change-price" class="btn btn-sm btn-warning">
                            Change Price
                        </button>
                        <button id="toggle-status" class="btn btn-sm btn-info">
                            Toggle Status
                        </button>
                    </div>

                    <h3 class="mt-4">Test 4: Array Iteration with Pipes</h3>
                    <div id="array-view"></div>
                </div>

                <div class="col-md-5">
                    <h3>Console Output</h3>
                    <div id="console" class="console-log"></div>
                    <button id="clear-console" class="btn btn-sm btn-secondary mt-2">Clear</button>
                </div>
            </div>
        </div>

        <script type="module">
            import View from "./src/core/View.js";
            import Model from "./src/core/Model.js";

            // Enhanced console logger
            const consoleEl = document.getElementById("console");
            const log = (message, type = "info") => {
                const timestamp = new Date().toLocaleTimeString();
                const div = document.createElement("div");
                div.className = `log-${type}`;
                div.textContent = `[${timestamp}] ${message}`;
                consoleEl.appendChild(div);
                consoleEl.scrollTop = consoleEl.scrollHeight;
            };

            // Test 1: Basic View with Pipes
            log("Test 1: Creating basic view with pipes", "info");

            class BasicView extends View {
                constructor(options = {}) {
                    super({
                        ...options,
                        template: `
                            <div class="alert alert-info">
                                <h5>{{data.title|uppercase}}</h5>
                                <p>{{data.message|capitalize}}</p>
                                <div class="pipe-demo">
                                    <small>Original: "{{data.rawText}}"</small><br>
                                    <small>Truncated: "{{data.rawText|truncate(20)}}"</small><br>
                                    <small>Slug: "{{data.rawText|slug}}"</small>
                                </div>
                                <p class="mb-0">
                                    <strong>Count:</strong> {{data.count|number(2)}} |
                                    <strong>Price:</strong> {{data.price|currency}} |
                                    <strong>Percent:</strong> {{data.ratio|percent}}
                                </p>
                            </div>
                        `,
                    });
                }

                onInit() {
                    log("BasicView.onInit() called", "success");
                }

                async onAfterRender() {
                    log("BasicView.onAfterRender() - pipes processed", "success");

                    // Test direct pipe access
                    log(`  data.title|uppercase: "${this.get("data.title|uppercase")}"`, "pipe");
                    log(`  data.price|currency: "${this.get("data.price|currency")}"`, "pipe");
                }
            }

            const basicView = new BasicView({
                id: "basic-view",
                data: {
                    title: "basic view demo",
                    message: "this demonstrates lifecycle hooks with pipe formatting",
                    rawText: "This is Some Example Text for Testing",
                    count: 42.7891,
                    price: 199.99,
                    ratio: 0.85,
                },
            });

            await basicView.render();
            log("Basic view rendered with pipes", "info");

            // Test 2: Parent-Child Relationship with Pipes
            log("\nTest 2: Creating parent-child views with pipes", "info");

            class ParentView extends View {
                constructor(options = {}) {
                    super({
                        ...options,
                        template: `
                            <div class="parent-view">
                                <h5>{{data.title|capitalize}} - {{getChildCount}} children</h5>
                                <p>{{data.description}}</p>
                                <p class="text-muted">Created: {{data.created|date("MMM DD, YYYY")}}</p>
                                <div id="child1"></div>
                                <div id="child2"></div>
                                <div id="child3"></div>
                            </div>
                        `,
                    });
                }

                onInit() {
                    log("ParentView.onInit() - adding children", "success");

                    // Add child views with different data
                    this.addChild(
                        new ChildView({
                            id: "child1",
                            data: {
                                name: "first child component",
                                value: 100,
                                type: "primary",
                            },
                        }),
                    );

                    this.addChild(
                        new ChildView({
                            id: "child2",
                            data: {
                                name: "second child component",
                                value: 250.5,
                                type: "success",
                            },
                        }),
                    );

                    this.addChild(
                        new ChildView({
                            id: "child3",
                            data: {
                                name: "third child component",
                                value: 75.25,
                                type: "warning",
                            },
                        }),
                    );
                }

                getChildCount() {
                    return this.children.size;
                }
            }

            class ChildView extends View {
                constructor(options = {}) {
                    super({
                        ...options,
                        template: `
                            <div class="child-view">
                                <span class="badge bg-{{data.type}} me-2">{{data.type|uppercase}}</span>
                                <strong>{{data.name|capitalize}}</strong>
                                <span class="float-end">{{data.value|currency}}</span>
                            </div>
                        `,
                    });
                }

                onInit() {
                    log(`ChildView[${this.id}].onInit() - parent: ${this.parent?.id}`, "success");
                }
            }

            const parentView = new ParentView({
                id: "parent-view",
                data: {
                    title: "parent view container",
                    description: "This view contains multiple children with formatted data",
                    created: new Date("2024-01-15T10:30:00"),
                },
            });

            await parentView.render();
            log("Parent-child views rendered with pipes", "info");

            // Test 3: Model Binding with Pipes
            log("\nTest 3: Creating model-bound view with pipes", "info");

            class ModelView extends View {
                constructor(options = {}) {
                    super({
                        ...options,
                        template: `
                            <div class="model-view">
                                <h5>{{model.name|uppercase}}</h5>
                                <div class="row">
                                    <div class="col-md-6">
                                        <p><strong>Status:</strong>
                                            <span class="badge bg-{{getStatusColor}}">
                                                {{model.status|uppercase}}
                                            </span>
                                        </p>
                                        <p><strong>Count:</strong> {{model.count}}</p>
                                        <p><strong>Price:</strong> {{model.price|currency}}</p>
                                        <p><strong>Discount:</strong> {{model.discount|percent}}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <p><strong>Updated:</strong> {{model.lastUpdated|relative}}</p>
                                        <p><strong>Created:</strong> {{model.created|date("MMM DD")}}</p>
                                        <p><strong>Email:</strong> {{model.email|lowercase}}</p>
                                        <p><strong>Total:</strong> {{getTotal|currency}}</p>
                                    </div>
                                </div>
                                <h6>Items ({{model.items.length}}):</h6>
                                <ul class="list-group list-group-flush">
                                    {{#model.items}}
                                    <li class="list-group-item d-flex justify-content-between">
                                        <span>{{name|capitalize}}</span>
                                        <span class="badge bg-primary">{{price|currency}}</span>
                                    </li>
                                    {{/model.items}}
                                    {{^model.items}}
                                    <li class="list-group-item text-muted">No items</li>
                                    {{/model.items}}
                                </ul>
                            </div>
                        `,
                    });
                    this.renderCount = 0;
                }

                async onBeforeRender() {
                    this.renderCount++;
                    log(`ModelView.onBeforeRender() - render #${this.renderCount}`, "success");
                }

                getStatusColor() {
                    const status = this.model?.get("status");
                    return status === "active" ? "success" : "secondary";
                }

                getTotal() {
                    const price = this.model?.get("price") || 0;
                    const count = this.model?.get("count") || 0;
                    const discount = this.model?.get("discount") || 0;
                    return price * count * (1 - discount);
                }
            }

            const model = new Model({
                name: "test product model",
                status: "active",
                count: 3,
                price: 49.99,
                discount: 0.1,
                email: "PRODUCT@EXAMPLE.COM",
                lastUpdated: new Date(),
                created: new Date(2024, 0, 1), // January 1, 2024 in local time
                items: [
                    { name: "feature one", price: 9.99 },
                    { name: "feature two", price: 14.99 },
                ],
            });

            const modelView = new ModelView({ id: "model-view" });
            modelView.setModel(model);
            await modelView.render();
            log("Model-bound view rendered with pipes", "info");

            // Test 4: Array View with Complex Pipes
            log("\nTest 4: Creating array view with complex pipes", "info");

            class ArrayView extends View {
                constructor(options = {}) {
                    super({
                        ...options,
                        template: `
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">{{data.title|uppercase}}</h6>
                                </div>
                                <div class="card-body">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Product</th>
                                                <th>Category</th>
                                                <th>Price</th>
                                                <th>Stock</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {{#data.products}}
                                            <tr>
                                                <td>{{name|capitalize}}</td>
                                                <td>
                                                    <span class="badge bg-secondary">
                                                        {{category|uppercase}}
                                                    </span>
                                                </td>
                                                <td>{{price|currency}}</td>
                                                <td>
                                                    {{#inStock}}
                                                        <span class="text-success">{{quantity}} units</span>
                                                    {{/inStock}}
                                                    {{^inStock}}
                                                        <span class="text-danger">Out of stock</span>
                                                    {{/inStock}}
                                                </td>
                                            </tr>
                                            {{/data.products}}
                                        </tbody>
                                        <tfoot>
                                            <tr>
                                                <th colspan="2">Total Value:</th>
                                                <th colspan="2">{{getTotalValue|currency}}</th>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        `,
                    });
                }

                getTotalValue() {
                    if (!this.data.products) return 0;
                    return this.data.products.reduce(
                        (sum, p) => sum + p.price * (p.quantity || 0),
                        0,
                    );
                }
            }

            const arrayView = new ArrayView({
                id: "array-view",
                data: {
                    title: "product inventory",
                    products: [
                        {
                            name: "laptop pro",
                            category: "electronics",
                            price: 1299.99,
                            quantity: 5,
                            inStock: true,
                        },
                        {
                            name: "wireless mouse",
                            category: "accessories",
                            price: 29.99,
                            quantity: 0,
                            inStock: false,
                        },
                        {
                            name: "usb cable",
                            category: "accessories",
                            price: 9.99,
                            quantity: 50,
                            inStock: true,
                        },
                        {
                            name: "monitor 4k",
                            category: "electronics",
                            price: 599.99,
                            quantity: 3,
                            inStock: true,
                        },
                    ],
                },
            });

            await arrayView.render();
            log("Array view rendered with complex pipes", "info");

            // Interactive buttons for model updates
            document.getElementById("update-model").addEventListener("click", () => {
                const count = model.get("count") || 0;
                model.set({
                    count: count + 1,
                    lastUpdated: new Date(),
                });
                log(`Model count updated to ${count + 1}`, "warning");
            });

            document.getElementById("add-item").addEventListener("click", () => {
                const items = model.get("items") || [];
                const newItem = {
                    name: `feature ${items.length + 1}`,
                    price: Math.random() * 50 + 10,
                };
                items.push(newItem);
                model.set({
                    items: [...items],
                    lastUpdated: new Date(),
                });
                log(`Added item: ${newItem.name} - $${newItem.price.toFixed(2)}`, "warning");
            });

            document.getElementById("change-price").addEventListener("click", () => {
                const newPrice = Math.random() * 100 + 50;
                model.set({
                    price: newPrice,
                    lastUpdated: new Date(),
                });
                log(`Price changed to $${newPrice.toFixed(2)}`, "warning");
            });

            document.getElementById("toggle-status").addEventListener("click", () => {
                const currentStatus = model.get("status");
                const newStatus = currentStatus === "active" ? "inactive" : "active";
                model.set({
                    status: newStatus,
                    lastUpdated: new Date(),
                });
                log(`Status toggled to: ${newStatus}`, "warning");
            });

            // Clear console
            document.getElementById("clear-console").addEventListener("click", () => {
                consoleEl.innerHTML = "";
                log("Console cleared", "info");
            });

            // Test pipe functionality directly
            log("\n=== Direct Pipe Tests ===", "pipe");
            log(
                `basicView.get('data.title|uppercase'): "${basicView.get("data.title|uppercase")}"`,
                "pipe",
            );
            log(`model.get('name|capitalize'): "${model.get("name|capitalize")}"`, "pipe");
            log(`model.get('price|currency'): "${model.get("price|currency")}"`, "pipe");
            log(`model.get('discount|percent'): "${model.get("discount|percent")}"`, "pipe");
            log(
                `arrayView.get('data.products.0.name|uppercase'): "${arrayView.get("data.products.0.name|uppercase")}"`,
                "pipe",
            );

            // Log final status
            log("\n=== All tests completed successfully! ===", "success");
            log("Try clicking the buttons to test model updates with pipes", "info");
        </script>
    </body>
</html>
