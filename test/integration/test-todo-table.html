<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TodoTablePage Test</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

    <style>
        body {
            padding: 20px;
            background-color: #f8f9fa;
        }
        .test-container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .test-controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .test-log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .test-log .log-entry {
            padding: 2px 0;
            border-bottom: 1px solid #e9ecef;
        }
        .test-log .log-success {
            color: #28a745;
        }
        .test-log .log-error {
            color: #dc3545;
        }
        .test-log .log-info {
            color: #007bff;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .status-success {
            background-color: #28a745;
        }
        .status-error {
            background-color: #dc3545;
        }
        .status-loading {
            background-color: #ffc107;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1 class="mb-4">
            <i class="bi bi-check2-square"></i>
            TodoTablePage Integration Test
        </h1>

        <!-- Test Controls -->
        <div class="test-controls">
            <h5>Test Controls</h5>
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">Test Filters</label>
                    <div class="btn-group-vertical w-100" role="group">
                        <button class="btn btn-outline-primary btn-sm" onclick="testFilter('kind', 'task')">
                            <i class="bi bi-filter"></i> Filter by Kind: Task
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="testFilter('kind', 'bug')">
                            <i class="bi bi-filter"></i> Filter by Kind: Bug
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="testFilter('kind', 'ticket')">
                            <i class="bi bi-filter"></i> Filter by Kind: Ticket
                        </button>
                        <button class="btn btn-outline-warning btn-sm" onclick="clearFilters()">
                            <i class="bi bi-x-circle"></i> Clear All Filters
                        </button>
                    </div>
                </div>

                <div class="col-md-4">
                    <label class="form-label">Test Pagination</label>
                    <div class="btn-group-vertical w-100" role="group">
                        <button class="btn btn-outline-primary btn-sm" onclick="testPagination(1)">
                            <i class="bi bi-arrow-left"></i> Go to Page 1
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="testPagination(2)">
                            <i class="bi bi-arrow-right"></i> Go to Page 2
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="testPagination(3)">
                            <i class="bi bi-arrow-right"></i> Go to Page 3
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="testPageSize(10)">
                            <i class="bi bi-list"></i> Set Page Size: 10
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="testPageSize(25)">
                            <i class="bi bi-list"></i> Set Page Size: 25
                        </button>
                    </div>
                </div>

                <div class="col-md-4">
                    <label class="form-label">Test Actions</label>
                    <div class="btn-group-vertical w-100" role="group">
                        <button class="btn btn-outline-success btn-sm" onclick="testRefresh()">
                            <i class="bi bi-arrow-clockwise"></i> Test Refresh
                        </button>
                        <button class="btn btn-outline-info btn-sm" onclick="checkTableState()">
                            <i class="bi bi-info-circle"></i> Check Table State
                        </button>
                        <button class="btn btn-outline-info btn-sm" onclick="checkUrlParams()">
                            <i class="bi bi-link-45deg"></i> Check URL Params
                        </button>
                        <button class="btn btn-outline-danger btn-sm" onclick="clearLog()">
                            <i class="bi bi-trash"></i> Clear Log
                        </button>
                    </div>
                </div>
            </div>

            <div class="mt-3">
                <label class="form-label">
                    <span class="status-indicator" id="status-indicator"></span>
                    Test Log
                </label>
                <div class="test-log" id="test-log"></div>
            </div>
        </div>

        <!-- Page Container -->
        <div id="page-container"></div>
    </div>

    <!-- Bootstrap 5 JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- MOJO Framework -->
    <script type="module">
        import { Router } from '../../src/core/Router.js';
        import TodoTablePage from '../../examples/pages/todos/TodoTablePage.js';

        // Make functions available globally for button onclick handlers
        window.todoTablePage = null;
        window.router = null;

        // Initialize logging
        const logContainer = document.getElementById('test-log');
        const statusIndicator = document.getElementById('status-indicator');

        function setStatus(status) {
            statusIndicator.className = 'status-indicator';
            switch(status) {
                case 'success':
                    statusIndicator.classList.add('status-success');
                    break;
                case 'error':
                    statusIndicator.classList.add('status-error');
                    break;
                case 'loading':
                    statusIndicator.classList.add('status-loading');
                    break;
                default:
                    statusIndicator.style.backgroundColor = '#6c757d';
            }
        }

        function log(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        window.clearLog = function() {
            logContainer.innerHTML = '';
            log('Log cleared', 'info');
        };

        // Test functions
        window.testFilter = async function(filterKey, filterValue) {
            setStatus('loading');
            log(`Testing filter: ${filterKey}=${filterValue}`, 'info');

            try {
                // Update URL with filter
                const params = new URLSearchParams(window.location.search);
                params.set(`filter_${filterKey}`, filterValue);
                window.router.navigate(`todotable?${params.toString()}`);

                // Wait for update
                await new Promise(resolve => setTimeout(resolve, 500));

                // Check if filter is applied
                if (window.todoTablePage && window.todoTablePage.table) {
                    const activeFilters = window.todoTablePage.table.activeFilters;
                    if (activeFilters[filterKey] === filterValue) {
                        log(`✓ Filter applied successfully: ${filterKey}=${filterValue}`, 'success');
                        setStatus('success');

                        // Check if filter pill is visible
                        const filterPill = document.querySelector(`[data-filter="${filterKey}"]`);
                        if (filterPill) {
                            log(`✓ Filter pill is visible for ${filterKey}`, 'success');
                        } else {
                            log(`✗ Filter pill not found for ${filterKey}`, 'error');
                        }
                    } else {
                        log(`✗ Filter not applied correctly. Expected ${filterValue}, got ${activeFilters[filterKey]}`, 'error');
                        setStatus('error');
                    }
                }
            } catch (error) {
                log(`✗ Error testing filter: ${error.message}`, 'error');
                setStatus('error');
            }
        };

        window.clearFilters = function() {
            setStatus('loading');
            log('Clearing all filters', 'info');

            // Clear URL parameters
            window.router.navigate('todotable');

            setTimeout(() => {
                if (window.todoTablePage && window.todoTablePage.table) {
                    const activeFilters = window.todoTablePage.table.activeFilters;
                    if (Object.keys(activeFilters).length === 0) {
                        log('✓ All filters cleared successfully', 'success');
                        setStatus('success');
                    } else {
                        log(`✗ Filters not cleared: ${JSON.stringify(activeFilters)}`, 'error');
                        setStatus('error');
                    }
                }
            }, 500);
        };

        window.testPagination = function(page) {
            setStatus('loading');
            log(`Testing pagination: page ${page}`, 'info');

            const params = new URLSearchParams(window.location.search);
            params.set('page', page);
            window.router.navigate(`todotable?${params.toString()}`);

            setTimeout(() => {
                if (window.todoTablePage && window.todoTablePage.table) {
                    const currentPage = window.todoTablePage.table.currentPage;
                    if (currentPage === page) {
                        log(`✓ Pagination successful: now on page ${page}`, 'success');
                        setStatus('success');
                    } else {
                        log(`✗ Pagination failed. Expected page ${page}, got ${currentPage}`, 'error');
                        setStatus('error');
                    }
                }
            }, 500);
        };

        window.testPageSize = function(size) {
            setStatus('loading');
            log(`Testing page size: ${size} items per page`, 'info');

            if (window.todoTablePage && window.todoTablePage.table) {
                window.todoTablePage.table.handlePageSizeChange(size);

                setTimeout(() => {
                    const itemsPerPage = window.todoTablePage.table.itemsPerPage;
                    if (itemsPerPage === size) {
                        log(`✓ Page size changed successfully to ${size}`, 'success');
                        setStatus('success');
                    } else {
                        log(`✗ Page size change failed. Expected ${size}, got ${itemsPerPage}`, 'error');
                        setStatus('error');
                    }
                }, 500);
            }
        };

        window.testRefresh = function() {
            setStatus('loading');
            log('Testing refresh functionality', 'info');

            if (window.todoTablePage && window.todoTablePage.handleRefresh) {
                window.todoTablePage.handleRefresh();
                log('✓ Refresh triggered successfully', 'success');
                setStatus('success');
            } else {
                log('✗ Refresh function not available', 'error');
                setStatus('error');
            }
        };

        window.checkTableState = function() {
            log('Checking table state...', 'info');

            if (window.todoTablePage && window.todoTablePage.table) {
                const table = window.todoTablePage.table;
                const state = {
                    currentPage: table.currentPage,
                    itemsPerPage: table.itemsPerPage,
                    activeFilters: table.activeFilters,
                    sortBy: table.sortBy,
                    sortDirection: table.sortDirection,
                    totalItems: table.collection?.models?.length || 0,
                    restEnabled: table.collection?.restEnabled || false
                };

                log(`Table State: ${JSON.stringify(state, null, 2)}`, 'info');
                setStatus('success');
            } else {
                log('✗ Table not available', 'error');
                setStatus('error');
            }
        };

        window.checkUrlParams = function() {
            const params = new URLSearchParams(window.location.search);
            const urlState = {};

            for (const [key, value] of params.entries()) {
                urlState[key] = value;
            }

            log(`URL Parameters: ${JSON.stringify(urlState, null, 2)}`, 'info');

            // Check if URL matches table state
            if (window.todoTablePage && window.todoTablePage.table) {
                const table = window.todoTablePage.table;
                let matches = true;

                // Check page
                const urlPage = parseInt(params.get('page')) || 1;
                if (urlPage !== table.currentPage) {
                    log(`✗ Page mismatch: URL=${urlPage}, Table=${table.currentPage}`, 'error');
                    matches = false;
                }

                // Check filters
                for (const [key, value] of params.entries()) {
                    if (key.startsWith('filter_')) {
                        const filterKey = key.substring(7);
                        if (table.activeFilters[filterKey] !== value) {
                            log(`✗ Filter mismatch for ${filterKey}: URL=${value}, Table=${table.activeFilters[filterKey]}`, 'error');
                            matches = false;
                        }
                    }
                }

                if (matches) {
                    log('✓ URL parameters match table state', 'success');
                    setStatus('success');
                } else {
                    setStatus('error');
                }
            }
        };

        // Initialize the app
        async function initApp() {
            log('Initializing TodoTablePage test...', 'info');
            setStatus('loading');

            try {
                // Initialize router
                const router = new Router({
                    container: 'page-container',
                    mode: 'param'
                });

                // Make router globally available
                window.router = router;
                window.MOJO = { router };

                // Register the TodoTablePage
                router.register('todotable', TodoTablePage);

                // Navigate to the todo table page
                await router.navigate('todotable');

                // Wait for page to initialize
                await new Promise(resolve => setTimeout(resolve, 1000));

                // Get reference to the page instance
                const container = document.getElementById('page-container');
                const pageElement = container.querySelector('[data-page="todotable"]');
                if (pageElement && pageElement.__mojoView) {
                    window.todoTablePage = pageElement.__mojoView;
                    log('✓ TodoTablePage initialized successfully', 'success');
                    log(`✓ Table has ${window.todoTablePage.table?.collection?.models?.length || 0} items`, 'success');
                    setStatus('success');
                } else {
                    log('✗ Failed to get TodoTablePage instance', 'error');
                    setStatus('error');
                }

            } catch (error) {
                log(`✗ Initialization error: ${error.message}`, 'error');
                console.error('Init error:', error);
                setStatus('error');
            }
        }

        // Start the app when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }
    </script>
</body>
</html>
