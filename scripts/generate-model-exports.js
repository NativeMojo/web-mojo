#!/usr/bin/env node

/**
 * MOJO Model Exports Generator
 * 
 * Automatically generates model export files by scanning the models directory.
 * This eliminates the need to manually update exports when adding new models.
 * 
 * Usage:
 *   node scripts/generate-model-exports.js
 *   npm run generate:models
 * 
 * What it does:
 *   1. Scans src/core/models/ for all .js files
 *   2. Generates src/core/models/index.js with all exports
 *   3. Optionally updates main src/index.js with model exports
 */

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __dirname = path.dirname(fileURLToPath(import.meta.url));

const config = {
    modelsDir: path.resolve(__dirname, '../src/core/models'),
    modelsIndexFile: path.resolve(__dirname, '../src/core/models/index.js'),
    mainIndexFile: path.resolve(__dirname, '../src/index.js'),
    updateMainIndex: process.argv.includes('--update-main'),
    dryRun: process.argv.includes('--dry-run'),
    verbose: process.argv.includes('--verbose') || process.argv.includes('-v')
};

function log(message, level = 'info') {
    const prefix = {
        info: 'ðŸ“',
        success: 'âœ…',
        warning: 'âš ï¸',
        error: 'âŒ',
        verbose: 'ðŸ”'
    };
    
    if (level === 'verbose' && !config.verbose) return;
    
    console.log(`${prefix[level]} ${message}`);
}

function findModelFiles() {
    if (!fs.existsSync(config.modelsDir)) {
        throw new Error(`Models directory not found: ${config.modelsDir}`);
    }

    const files = fs.readdirSync(config.modelsDir)
        .filter(file => file.endsWith('.js') && file !== 'index.js')
        .sort();

    log(`Found ${files.length} model files`, 'verbose');
    files.forEach(file => log(`  â€¢ ${file}`, 'verbose'));

    return files;
}

function generateModelName(filename) {
    // Convert filename to model name (remove .js extension)
    return path.basename(filename, '.js');
}

function generateModelsIndex(modelFiles) {
    const header = `/**
 * MOJO Core Models - Auto-generated exports
 * 
 * This file is automatically generated by scripts/generate-model-exports.js
 * Do not edit manually - run 'npm run generate:models' to regenerate
 * 
 * Usage examples:
 *   import { User, Job, Email } from 'web-mojo/models';
 *   import { UserList, JobForms } from 'web-mojo/models';
 * 
 * Generated on: ${new Date().toISOString()}
 */

`;

    const exports = modelFiles.map(file => {
        const modelName = generateModelName(file);
        return `// ${modelName} model exports
export * from './${file}';
export { default as ${modelName} } from './${file}';`;
    }).join('\n\n');

    const footer = `

// Re-export core classes for convenience
export { default as Model } from '../Model.js';
export { default as Collection } from '../Collection.js';
export { default as Rest } from '../Rest.js';
`;

    return header + exports + footer;
}

function generateMainIndexModelExports(modelFiles) {
    const header = `
// Core Models - auto-generated exports (run 'npm run generate:models' to update)`;
    
    const exports = modelFiles.map(file => {
        return `export * from '@core/models/${file}';`;
    }).join('\n');

    return header + '\n' + exports;
}

function updateMainIndex(modelFiles) {
    if (!fs.existsSync(config.mainIndexFile)) {
        log(`Main index file not found: ${config.mainIndexFile}`, 'warning');
        return;
    }

    const content = fs.readFileSync(config.mainIndexFile, 'utf8');
    const newModelExports = generateMainIndexModelExports(modelFiles);

    // Find existing model exports section
    const modelExportStart = content.indexOf('// Core Models');
    const modelExportEnd = content.indexOf('\n// ', modelExportStart + 1);

    let newContent;
    if (modelExportStart !== -1) {
        // Replace existing model exports
        const before = content.substring(0, modelExportStart);
        const after = modelExportEnd !== -1 ? content.substring(modelExportEnd) : '';
        newContent = before + newModelExports + '\n' + after;
        log('Updated existing model exports in main index', 'verbose');
    } else {
        // Add model exports after Collection import
        const collectionImport = content.indexOf('export { default as Collection }');
        if (collectionImport !== -1) {
            const insertPoint = content.indexOf('\n', collectionImport) + 1;
            const before = content.substring(0, insertPoint);
            const after = content.substring(insertPoint);
            newContent = before + newModelExports + '\n' + after;
            log('Added model exports to main index', 'verbose');
        } else {
            log('Could not find insertion point in main index', 'warning');
            return;
        }
    }

    if (config.dryRun) {
        log('Would update main index.js', 'info');
    } else {
        fs.writeFileSync(config.mainIndexFile, newContent);
        log('Updated main index.js with model exports', 'success');
    }
}

function generatePackageJsonExport() {
    return {
        "./models": {
            "import": "./src/core/models/index.js",
            "require": "./src/core/models/index.js"
        }
    };
}

function updatePackageJson() {
    const packagePath = path.resolve(__dirname, '../package.json');
    if (!fs.existsSync(packagePath)) {
        log('package.json not found', 'warning');
        return;
    }

    const pkg = JSON.parse(fs.readFileSync(packagePath, 'utf8'));
    const modelsExport = generatePackageJsonExport();

    if (!pkg.exports) {
        pkg.exports = {};
    }

    // Check if models export already exists
    if (pkg.exports['./models']) {
        log('Models export already exists in package.json', 'verbose');
        return;
    }

    // Add models export (insert after main exports, before templates)
    const newExports = {};
    for (const [key, value] of Object.entries(pkg.exports)) {
        newExports[key] = value;
        // Insert models export after docit
        if (key === './docit') {
            Object.assign(newExports, modelsExport);
        }
    }

    pkg.exports = newExports;

    if (config.dryRun) {
        log('Would add models export to package.json', 'info');
    } else {
        fs.writeFileSync(packagePath, JSON.stringify(pkg, null, 4) + '\n');
        log('Added models export to package.json', 'success');
    }
}

function main() {
    console.log('ðŸ”§ MOJO Model Exports Generator');
    console.log('================================');
    console.log(`Models directory: ${config.modelsDir}`);
    console.log(`Mode: ${config.dryRun ? 'DRY RUN' : 'UPDATE'}`);
    console.log('');

    try {
        // Find all model files
        const modelFiles = findModelFiles();
        
        if (modelFiles.length === 0) {
            log('No model files found', 'warning');
            return;
        }

        // Generate models/index.js
        const modelsIndexContent = generateModelsIndex(modelFiles);
        
        if (config.dryRun) {
            log('Would generate models/index.js:', 'info');
            console.log('---');
            console.log(modelsIndexContent.substring(0, 500) + '...');
            console.log('---');
        } else {
            fs.writeFileSync(config.modelsIndexFile, modelsIndexContent);
            log(`Generated ${config.modelsIndexFile}`, 'success');
        }

        // Update main index.js if requested
        if (config.updateMainIndex) {
            updateMainIndex(modelFiles);
        }

        // Update package.json export
        updatePackageJson();

        // Summary
        console.log('\nðŸ“Š Generation Summary');
        console.log('====================');
        console.log(`Models processed: ${modelFiles.length}`);
        console.log(`Files ${config.dryRun ? 'would be ' : ''}updated:`);
        console.log('  â€¢ src/core/models/index.js');
        if (config.updateMainIndex) {
            console.log('  â€¢ src/index.js');
        }
        console.log('  â€¢ package.json (export added if missing)');

        if (config.dryRun) {
            console.log('\nðŸ’¡ Run without --dry-run to apply changes');
        } else {
            console.log('\nâœ… Model exports generated successfully!');
            console.log('\nUsage examples:');
            console.log("  import { User, Job } from 'web-mojo/models';");
            console.log("  import { UserList, JobForms } from 'web-mojo/models';");
        }

    } catch (error) {
        log(`Error: ${error.message}`, 'error');
        process.exit(1);
    }
}

// Handle command line help
if (process.argv.includes('--help') || process.argv.includes('-h')) {
    console.log(`
MOJO Model Exports Generator - Automatically generate model export files

Usage: node scripts/generate-model-exports.js [options]

Options:
  --update-main     Also update main src/index.js with model exports
  --dry-run         Show what would be generated without making changes
  --verbose, -v     Show detailed output
  --help, -h        Show this help message

Examples:
  node scripts/generate-model-exports.js
  node scripts/generate-model-exports.js --dry-run --verbose
  node scripts/generate-model-exports.js --update-main

This script automatically:
  â€¢ Scans src/core/models/ for all .js files
  â€¢ Generates src/core/models/index.js with proper exports
  â€¢ Adds package.json export for 'web-mojo/models'
  â€¢ Optionally updates main index.js

After adding a new model, just run:
  npm run generate:models
    `);
    process.exit(0);
}

main();