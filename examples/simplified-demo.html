<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MOJO Simplified Architecture Demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .performance-badge {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #28a745;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 1000;
        }
        .instance-info {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="performance-badge">
        <div>Navigation Time: <span id="nav-time">0ms</span></div>
        <div>Active Pages: <span id="page-count">0</span></div>
    </div>

    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="bi bi-lightning-charge"></i> MOJO Demo
            </a>
            <ul class="navbar-nav ms-auto">
                <li class="nav-item">
                    <a class="nav-link" href="#" data-page="dashboard">Dashboard</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-page="users">Users</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-page="settings">Settings</a>
                </li>
            </ul>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-3">
                <div class="card">
                    <div class="card-header">
                        <h6>Quick Navigation</h6>
                    </div>
                    <div class="card-body">
                        <div class="list-group list-group-flush">
                            <a href="#" class="list-group-item list-group-item-action" data-page="dashboard">
                                <i class="bi bi-speedometer2"></i> Dashboard
                            </a>
                            <a href="#" class="list-group-item list-group-item-action" data-page="users">
                                <i class="bi bi-people"></i> Users
                            </a>
                            <a href="#" class="list-group-item list-group-item-action" data-page="settings">
                                <i class="bi bi-gear"></i> Settings
                            </a>
                        </div>
                    </div>
                </div>

                <div class="card mt-3">
                    <div class="card-header">
                        <h6>Architecture Benefits</h6>
                    </div>
                    <div class="card-body">
                        <ul class="small">
                            <li>Single page instances</li>
                            <li>State preservation</li>
                            <li>Clean DOM (1 page at a time)</li>
                            <li>Fast navigation (&lt;50ms)</li>
                            <li>Smart re-rendering</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="col-md-9">
                <div id="app">
                    <!-- Pages render here -->
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import WebApp from '../src/app/WebApp.js';
        import Page from '../src/core/Page.js';

        // Performance monitoring
        let navStartTime = 0;
        const updateNavTime = (time) => {
            document.getElementById('nav-time').textContent = `${time}ms`;
        };
        const updatePageCount = (count) => {
            document.getElementById('page-count').textContent = count;
        };

        // Define pages
        class DashboardPage extends Page {
            constructor() {
                super({
                    pageName: 'dashboard',
                    route: '/dashboard',
                    pageIcon: 'bi bi-speedometer2',
                    displayName: 'Dashboard'
                });
                this.instanceId = Math.random().toString(36).substr(2, 9);
                this.renderCount = 0;
                this.createdAt = new Date();
            }

            async getTemplate() {
                this.renderCount++;
                return `
                    <div class="card">
                        <div class="card-header">
                            <h4><i class="${this.pageIcon}"></i> ${this.displayName}</h4>
                        </div>
                        <div class="card-body">
                            <div class="instance-info">
                                <div>Instance ID: ${this.instanceId}</div>
                                <div>Created: ${this.createdAt.toLocaleTimeString()}</div>
                                <div>Render Count: ${this.renderCount}</div>
                            </div>

                            <div class="row">
                                <div class="col-md-4">
                                    <div class="card text-white bg-primary mb-3">
                                        <div class="card-body">
                                            <h5>Active Users</h5>
                                            <h2>1,234</h2>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card text-white bg-success mb-3">
                                        <div class="card-body">
                                            <h5>Revenue</h5>
                                            <h2>$45,678</h2>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card text-white bg-info mb-3">
                                        <div class="card-body">
                                            <h5>Growth</h5>
                                            <h2>+23%</h2>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <p>Navigate away and come back - notice the same instance is reused!</p>
                        </div>
                    </div>
                `;
            }
        }

        class UsersPage extends Page {
            constructor() {
                super({
                    pageName: 'users',
                    route: '/users',
                    pageIcon: 'bi bi-people',
                    displayName: 'Users'
                });
                this.instanceId = Math.random().toString(36).substr(2, 9);
                this.renderCount = 0;
                this.createdAt = new Date();
            }

            async getTemplate() {
                this.renderCount++;
                return `
                    <div class="card">
                        <div class="card-header">
                            <h4><i class="${this.pageIcon}"></i> ${this.displayName}</h4>
                        </div>
                        <div class="card-body">
                            <div class="instance-info">
                                <div>Instance ID: ${this.instanceId}</div>
                                <div>Created: ${this.createdAt.toLocaleTimeString()}</div>
                                <div>Render Count: ${this.renderCount}</div>
                            </div>

                            <div class="mb-3">
                                <input type="text" class="form-control" name="search"
                                       placeholder="Search users... (type something and navigate away)">
                            </div>

                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>1</td>
                                        <td>John Doe</td>
                                        <td>john@example.com</td>
                                        <td><span class="badge bg-success">Active</span></td>
                                    </tr>
                                    <tr>
                                        <td>2</td>
                                        <td>Jane Smith</td>
                                        <td>jane@example.com</td>
                                        <td><span class="badge bg-success">Active</span></td>
                                    </tr>
                                    <tr>
                                        <td>3</td>
                                        <td>Bob Johnson</td>
                                        <td>bob@example.com</td>
                                        <td><span class="badge bg-warning">Pending</span></td>
                                    </tr>
                                </tbody>
                            </table>

                            <p class="text-muted">Scroll down to test scroll position preservation...</p>
                            ${Array(20).fill(0).map((_, i) => `<p>Extra content line ${i + 1}</p>`).join('')}
                        </div>
                    </div>
                `;
            }
        }

        class SettingsPage extends Page {
            constructor() {
                super({
                    pageName: 'settings',
                    route: '/settings',
                    pageIcon: 'bi bi-gear',
                    displayName: 'Settings'
                });
                this.instanceId = Math.random().toString(36).substr(2, 9);
                this.renderCount = 0;
                this.createdAt = new Date();
            }

            async getTemplate() {
                this.renderCount++;
                return `
                    <div class="card">
                        <div class="card-header">
                            <h4><i class="${this.pageIcon}"></i> ${this.displayName}</h4>
                        </div>
                        <div class="card-body">
                            <div class="instance-info">
                                <div>Instance ID: ${this.instanceId}</div>
                                <div>Created: ${this.createdAt.toLocaleTimeString()}</div>
                                <div>Render Count: ${this.renderCount}</div>
                            </div>

                            <form>
                                <h5>Application Settings</h5>
                                <div class="mb-3">
                                    <label class="form-label">Site Name</label>
                                    <input type="text" class="form-control" name="siteName" value="MOJO Demo">
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Email Notifications</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="emailNotifications" id="emailNotif" checked>
                                        <label class="form-check-label" for="emailNotif">
                                            Enable email notifications
                                        </label>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Theme</label>
                                    <select class="form-select" name="theme">
                                        <option value="light">Light</option>
                                        <option value="dark">Dark</option>
                                        <option value="auto" selected>Auto</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Update Frequency</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="frequency" value="realtime" id="realtime">
                                        <label class="form-check-label" for="realtime">Real-time</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="frequency" value="hourly" id="hourly" checked>
                                        <label class="form-check-label" for="hourly">Hourly</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="frequency" value="daily" id="daily">
                                        <label class="form-check-label" for="daily">Daily</label>
                                    </div>
                                </div>

                                <button type="button" class="btn btn-primary">Save Settings</button>
                            </form>

                            <hr>
                            <p class="text-muted">
                                <strong>Test State Preservation:</strong> Change these settings, navigate away,
                                and come back. Your changes will be preserved!
                            </p>
                        </div>
                    </div>
                `;
            }
        }

        // Initialize app
        const app = new WebApp({
            name: 'MOJO Simplified Demo',
            container: '#app',
            routerMode: 'param',
            defaultRoute: 'dashboard'
        });

        // Register pages (classes, not instances!)
        app.registerPage('dashboard', DashboardPage);
        app.registerPage('users', UsersPage);
        app.registerPage('settings', SettingsPage);

        // Add routes
        app.router.addRoute('/dashboard', 'dashboard');
        app.router.addRoute('/users', 'users');
        app.router.addRoute('/settings', 'settings');
        app.router.addRoute('/', 'dashboard');

        // Monitor navigation performance
        app.router.addGuard(async (match, page) => {
            navStartTime = performance.now();
            return true;
        });

        // After navigation guard
        app.router.guards.afterEach.push(async (match, page) => {
            const navTime = Math.round(performance.now() - navStartTime);
            updateNavTime(navTime);
            updatePageCount(app.pageCache.size);

            // Log performance
            console.log(`Navigation to ${match.pageName} took ${navTime}ms`);
            console.log(`Active page instances: ${app.pageCache.size}`);
            console.log('Page cache:', Array.from(app.pageCache.keys()));
        });

        // Start the app
        await app.start();

        // Setup navigation links
        document.querySelectorAll('[data-page]').forEach(link => {
            link.addEventListener('click', async (e) => {
                e.preventDefault();
                const pageName = e.currentTarget.dataset.page;
                await app.router.navigateToPage(pageName);

                // Update active state
                document.querySelectorAll('[data-page]').forEach(l => {
                    l.classList.remove('active');
                    if (l.dataset.page === pageName) {
                        l.classList.add('active');
                    }
                });
            });
        });

        // Initial page count
        updatePageCount(app.pageCache.size);

        // Make app available for debugging
        window.demoApp = app;

        console.log('ðŸš€ MOJO Simplified Architecture Demo Started');
        console.log('Navigate between pages and watch the performance metrics!');
    </script>
</body>
</html>
