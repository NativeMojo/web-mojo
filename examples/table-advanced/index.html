<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>MOJO Table Component Example</title>

        <!-- Bootstrap CSS -->
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
            rel="stylesheet"
        />
        <!-- Bootstrap Icons -->
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
            rel="stylesheet"
        />

        <!-- Import Map for ES Modules -->
        <script type="importmap">
            {
                "imports": {
                    "mustache": "https://cdn.jsdelivr.net/npm/mustache@4.2.0/mustache.mjs"
                }
            }
        </script>
    </head>
    <body class="bg-light">
        <div class="container-fluid py-2">
            <!-- Header -->
            <div class="row mb-3">
                <div class="col">
                    <h5 class="mb-1">
                        <i class="bi bi-table me-2 text-primary"></i>
                        MOJO Table Component Demo
                    </h5>
                    <p class="text-muted mb-0 small">
                        Advanced table with just a few lines of configuration code
                    </p>
                </div>
                <div class="col-auto">
                    <a href="../" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-arrow-left me-1"></i>
                        Back to Examples
                    </a>
                </div>
            </div>

            <!-- Code Comparison -->
            <div class="row mb-3">
                <div class="col">
                    <div class="alert alert-success py-2">
                        <h6 class="alert-heading mb-1">
                            <i class="bi bi-lightning me-1"></i>
                            Framework Power Demonstration
                        </h6>
                        <div class="row small">
                            <div class="col-md-6">
                                <strong>Manual Implementation:</strong> 600+ lines of JavaScript<br />
                                <strong>HTML + CSS:</strong> 300+ lines of complex markup<br />
                                <strong>Total:</strong> 900+ lines of code to maintain
                            </div>
                            <div class="col-md-6">
                                <strong>MOJO Table Component:</strong> ~50 lines of config<br />
                                <strong>All Features:</strong> Built-in automatically<br />
                                <strong>Result:</strong> 95% less code, same functionality! üöÄ
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Status Indicator -->
            <div class="row mb-3">
                <div class="col">
                    <div id="data-status" class="alert alert-info py-2">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                            <span>Initializing table with preloaded data...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Table Container -->
            <div class="row">
                <div class="col">
                    <div id="users-table-container">
                        <!-- MOJO Table will render here -->
                    </div>
                </div>
            </div>

            <!-- Code Example -->
            <div class="row mt-4">
                <div class="col">
                    <div class="card">
                        <div class="card-header py-2">
                            <h6 class="mb-0">
                                <i class="bi bi-code-square me-1"></i>
                                Complete Implementation Code
                            </h6>
                        </div>
                        <div class="card-body p-3">
                            <pre class="mb-0 small"><code>// 1. Define your data model
class User extends RestModel {
    static endpoint = '/api/users';
    static validations = {
        name: { required: true },
        email: { required: true, pattern: /^[^\s@]+@[^\s@]+\.[^\s@]+$/ }
    };
}

// 2. Define your collection
class Users extends DataList {
    constructor() { super(User); }
}

// 3. Configure the table (that's it!)
const usersTable = new Table({
    Collection: Users,
    container: '#users-table-container',
    columns: [
        { key: 'id', title: 'ID', sortable: true },
        { key: 'name', title: 'Name', sortable: true },
        { key: 'email', title: 'Email', sortable: true },
        { key: 'department', title: 'Department', sortable: true },
        { key: 'status', title: 'Status', sortable: true,
          formatter: (value) => `&lt;span class="badge ${value === 'active' ? 'bg-success' : 'bg-secondary'}"&gt;${value}&lt;/span&gt;` },
        { key: 'lastLogin', title: 'Last Login', sortable: true, formatter: 'date' }
    ],
    filters: {
        status: {
            type: 'select',
            placeholder: 'All Status',
            options: [
                { value: 'active', label: 'Active' },
                { value: 'inactive', label: 'Inactive' }
            ]
        },
        department: {
            type: 'select',
            placeholder: 'All Departments',
            options: [
                { value: 'Engineering', label: 'Engineering' },
                { value: 'Marketing', label: 'Marketing' },
                { value: 'Sales', label: 'Sales' },
                { value: 'Support', label: 'Support' }
            ]
        }
    },
    options: {
        searchable: true,
        sortable: true,
        paginated: true,
        exportable: true,
        selectable: true
    }
});

// 4. Render it
usersTable.render();</code></pre>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Features Included -->
            <div class="row mt-3">
                <div class="col">
                    <div class="alert alert-info py-2 mb-1">
                        <h6 class="alert-heading mb-1">
                            <i class="bi bi-check-circle me-1"></i>
                            Features Included Automatically
                        </h6>
                        <div class="row small">
                            <div class="col-md-4">
                                ‚úÖ Search across all columns<br />
                                ‚úÖ Column sorting (asc/desc)<br />
                                ‚úÖ Advanced filtering<br />
                                ‚úÖ Pagination with size options
                            </div>
                            <div class="col-md-4">
                                ‚úÖ Row selection<br />
                                ‚úÖ CSV export<br />
                                ‚úÖ Responsive design<br />
                                ‚úÖ Loading states
                            </div>
                            <div class="col-md-4">
                                ‚úÖ Error handling<br />
                                ‚úÖ Action buttons<br />
                                ‚úÖ Data validation<br />
                                ‚úÖ Event system
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bootstrap JS -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

        <!-- Application Logic -->
        <script type="module">
            import MOJO, { RestModel, DataList } from "../../src/mojo.js";
            import Table from "../../src/components/Table.js";

            // No need for mock REST client anymore - using preloaded option instead



            // 1. Define User Model (same as before)
            class User extends RestModel {
                static endpoint = "/api/users";
                static validations = {
                    name: { required: true, minLength: 2, maxLength: 50 },
                    email: { required: true, pattern: /^[^\s@]+@[^\s@]+\.[^\s@]+$/ },
                    age: { type: "number", min: 13, max: 120 },
                    active: { type: "boolean", default: true },
                };

                getFullName() {
                    return `${this.get('name')} (${this.get('email')})`;
                }

                async activate() {
                    this.set('active', true);
                    return await this.save();
                }
            }

            // 2. Define Users Collection (same as before)
            class Users extends DataList {
                constructor() {
                    super(User, {
                        endpoint: "/api/users",
                        preloaded: true,
                        restEnabled: false  // Explicit: using preloaded data, no REST calls
                    });
                }

                getActiveUsers() {
                    return this.filter((user) => user.get('active'));
                }

                async fetchWithPagination(page = 1, limit = 10) {
                    const params = { page, limit };
                    return await this.fetchAll(params);
                }
            }

            // Generate sample data (same as before)
            function generateSampleUsers() {
                const departments = ["Engineering", "Marketing", "Sales", "Support", "HR"];
                const statuses = ["active", "inactive"];
                const names = [
                    "John Doe",
                    "Jane Smith",
                    "Bob Wilson",
                    "Alice Brown",
                    "Charlie Davis",
                    "Diana Prince",
                    "Edward Norton",
                    "Fiona Green",
                    "George Lucas",
                    "Helen Troy",
                    "Ivan Petrov",
                    "Julia Roberts",
                    "Kevin Hart",
                    "Linda Hamilton",
                    "Mike Tyson",
                    "Nancy Drew",
                    "Oscar Wilde",
                    "Paula Abdul",
                    "Quincy Jones",
                    "Rita Hayworth",
                    "Steve Jobs",
                    "Tina Turner",
                    "Uma Thurman",
                    "Victor Hugo",
                    "Wendy Williams",
                    "Xavier Woods",
                    "Yvonne Strahovski",
                    "Zoe Saldana",
                    "Adam Smith",
                    "Betty White",
                    "Carl Jung",
                    "Dolly Parton",
                    "Elvis Presley",
                    "Frank Sinatra",
                    "Grace Kelly",
                ];

                const users = [];
                for (let i = 1; i <= 100; i++) {
                    const name = names[Math.floor(Math.random() * names.length)];
                    const email = name.toLowerCase().replace(/\s+/g, ".") + "@example.com";
                    const department = departments[Math.floor(Math.random() * departments.length)];
                    const status = statuses[Math.floor(Math.random() * statuses.length)];
                    const lastLoginDays = Math.floor(Math.random() * 30);
                    const lastLogin = new Date(Date.now() - lastLoginDays * 24 * 60 * 60 * 1000);

                    users.push({
                        id: i,
                        name: name,
                        email: email,
                        department: department,
                        status: status,
                        lastLogin: lastLogin,
                        age: Math.floor(Math.random() * 40) + 20,
                    });
                }
                return users;
            }

            // Global utility functions for table actions
            window.editUser = function(userId) {
                console.log("Edit user:", userId);
                // In a real app, this would open a modal or navigate to edit page
                alert(`Edit user functionality would be implemented here for user ID: ${userId}`);
            };

            window.deleteUser = function(userId) {
                console.log("Delete user:", userId);
                if (confirm(`Are you sure you want to delete user ${userId}?`)) {
                    // In a real app, this would call the API to delete the user
                    alert(`Delete user functionality would be implemented here for user ID: ${userId}`);
                    // You could also refresh the table: usersTable.refresh();
                }
            };

            // 3. Initialize table demo
            async function initializeTableDemo() {
                // Create collection with sample data
                const usersCollection = new Users();
                const sampleData = generateSampleUsers();

                sampleData.forEach(userData => {
                    usersCollection.add(new User(userData));
                });

                console.log(`‚úÖ Created collection with ${usersCollection.models.length} users`);
                console.log("üîç First user:", usersCollection.models[0]?.get('name'));



                // Update status indicator
                let statusDiv = document.getElementById('data-status');
                if (statusDiv) {
                    statusDiv.innerHTML = `
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <i class="bi bi-database-check text-success me-2"></i>
                                <strong>Preloaded Data Active:</strong> ${usersCollection.models.length} users loaded
                                <small class="text-muted ms-2">‚Ä¢ No REST API calls needed</small>
                            </div>
                            <span class="badge bg-success">preloaded: true</span>
                        </div>
                    `;
                    statusDiv.className = 'alert alert-success py-2';
                }

                // Configure the table

                const usersTable = new Table({
                        Collection: Users,
                        collection: usersCollection,
                        container: '#users-table-container',
                        columns: [
                            {
                                key: "id",
                                title: "ID",
                                sortable: true,
                                width: "5%",
                            },
                            {
                                key: "name",
                                title: "Name",
                                sortable: true,
                                width: "20%",
                                formatter: (value) => value || "N/A", // Fallback for missing data
                            },
                            {
                                key: "email",
                                title: "Email",
                                sortable: true,
                                width: "25%",
                            },
                            {
                                key: "department",
                                title: "Department",
                                sortable: true,
                                width: "15%",
                            },
                            {
                                key: "status",
                                title: "Status",
                                sortable: true,
                                width: "10%",
                                formatter: (value) => {
                                    const badgeClass = value === "active" ? "bg-success" : "bg-secondary";
                                    const text = value === "active" ? "Active" : "Inactive";
                                    return `<span class="badge ${badgeClass}">${text}</span>`;
                                },
                            },
                            {
                                key: "lastLogin",
                                title: "Last Login",
                                sortable: true,
                                width: "15%",
                                formatter: (value) => {
                                    try {
                                        if (!value) return "Never";
                                        const loginDate = new Date(value);
                                        if (isNaN(loginDate.getTime())) return "Invalid date";

                                        const now = new Date();
                                        const diffTime = Math.abs(now - loginDate);
                                        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

                                        if (diffDays === 0) return "Today";
                                        if (diffDays === 1) return "Yesterday";
                                        if (diffDays < 7) return `${diffDays} days ago`;
                                        if (diffDays < 30) return `${Math.floor(diffDays / 7)} weeks ago`;
                                        return loginDate.toLocaleDateString();
                                    } catch (error) {
                                        console.warn("Date formatter error:", error);
                                        return "Error";
                                    }
                                },
                            },
                            {
                                key: "actions",
                            title: "Actions",
                            sortable: false,
                            width: "10%",
                            formatter: (value, item) => `
                                <div class="btn-group btn-group-sm" role="group">
                                    <button class="btn btn-outline-primary" onclick="editUser(&quot;${item.id}&quot;)" title="Edit">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-outline-danger" onclick="deleteUser(&quot;${item.id}&quot;)" title="Delete">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            `,
                        },
                    ],
                    filters: {
                        status: {
                            type: "select",
                            placeholder: "All Status",
                            options: [
                                { value: "active", label: "Active" },
                                { value: "inactive", label: "Inactive" },
                            ],
                        },
                        department: {
                            type: "select",
                            placeholder: "All Departments",
                            options: [
                                { value: "Engineering", label: "Engineering" },
                                { value: "Marketing", label: "Marketing" },
                                { value: "Sales", label: "Sales" },
                                { value: "Support", label: "Support" },
                                { value: "HR", label: "HR" },
                            ],
                        },
                    },
                    // Pass options directly to Table constructor, not nested
                    searchable: true,
                    sortable: true,
                    paginated: true,
                    exportable: true,
                    selectable: true,
                    responsive: true,
                    striped: false,
                    bordered: true,
                    hover: true,
                    preloaded: true  // Use preloaded data, don't fetch from REST
                });



                // Render the table
                await usersTable.render();

                // Update status to show table is fully rendered
                statusDiv = document.getElementById('data-status');
                if (statusDiv) {
                    const rowCount = document.querySelectorAll('#users-table-container tbody tr').length;
                    statusDiv.innerHTML = `
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <i class="bi bi-check-circle text-success me-2"></i>
                                <strong>Table Loaded:</strong> ${rowCount} rows rendered with preloaded data
                                <small class="text-muted ms-2">‚Ä¢ Zero REST API calls ‚Ä¢ Instant loading</small>
                            </div>
                            <div>
                                <span class="badge bg-success me-1">preloaded: true</span>
                                <span class="badge bg-info">Framework Power</span>
                            </div>
                        </div>
                    `;
                }
            }

            // Initialize application
            document.addEventListener("DOMContentLoaded", async () => {
                await initializeTableDemo();
            });
        </script>
    </body>
                console.log("");
                console.log("üöÄ Compare this to the previous manual implementation:");
                console.log("   Manual: 900+ lines of code");
                console.log("   MOJO:   ~50 lines of config");
                console.log("   Savings: 95% less code to maintain!");
                console.log("");
                console.log("üîß Debug Info:");
                console.log("   RestModel:", User);
                console.log("   DataList:", Users);
                console.log("   Table:", Table);
                console.log("   Sample data:", sampleData.slice(0, 2));
                console.log("   Collection size:", usersCollection.models?.length || 0);

                // Add error handler for uncaught errors
                window.addEventListener("error", (event) => {
                    console.error("‚ùå Global error caught:", event.error);
                });

                // Initialize the table
                await initializeTable();
            });
        </script>
    </body>
</html>
