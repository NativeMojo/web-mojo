<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>MOJO TODO REST Table Example</title>

        <!-- Bootstrap CSS -->
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
            rel="stylesheet"
        />
        <!-- Bootstrap Icons -->
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
            rel="stylesheet"
        />

        <!-- Import Map for ES Modules -->
        <script type="importmap">
            {
                "imports": {
                    "mustache": "https://cdn.jsdelivr.net/npm/mustache@4.2.0/mustache.mjs"
                }
            }
        </script>
    </head>
    <body class="bg-light">
        <div class="container-fluid py-2">
            <!-- Header -->
            <div class="row mb-3">
                <div class="col">
                    <h5 class="mb-1">
                        <i class="bi bi-list-task me-2 text-primary"></i>
                        TODO REST API Table Example
                    </h5>
                    <p class="text-muted mb-0 small">
                        Live data from REST API with real-time table rendering
                    </p>
                </div>
                <div class="col-auto">
                    <a href="../" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-arrow-left me-1"></i>
                        Back to Examples
                    </a>
                </div>
            </div>

            <!-- API Status -->
            <div class="row mb-3">
                <div class="col-md-8">
                    <div id="api-status" class="alert alert-info py-2 mb-2">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                            <span>Connecting to API...</span>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body p-2">
                            <h6 class="card-title mb-1">API Info</h6>
                            <small class="text-muted">
                                <strong>Endpoint:</strong> /api/example/todo<br />
                                <strong>Host:</strong> <span id="api-host">0.0.0.0:8881</span><br />
                                <strong>Records:</strong> <span id="record-count">-</span><br />
                                <strong>Pagination:</strong> uses size/start params
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="row mb-3">
                <div class="col">
                    <div class="d-flex gap-2 align-items-center">
                        <button id="refresh-btn" class="btn btn-sm btn-primary">
                            <i class="bi bi-arrow-clockwise me-1"></i>
                            Refresh Data
                        </button>
                        <button id="toggle-notes" class="btn btn-sm btn-outline-secondary">
                            <i class="bi bi-eye me-1"></i>
                            Toggle Notes
                        </button>
                        <div class="ms-auto">
                            <small class="text-muted">
                                Last updated: <span id="last-updated">-</span>
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Table Container -->
            <div class="row">
                <div class="col">
                    <div id="todos-table-container">
                        <!-- MOJO Table will render here -->
                    </div>
                </div>
            </div>

            <!-- Code Example -->
            <div class="row mt-4">
                <div class="col">
                    <div class="card">
                        <div class="card-header py-2">
                            <h6 class="mb-0">
                                <i class="bi bi-code-square me-1"></i>
                                Implementation Code
                            </h6>
                        </div>
                        <div class="card-body p-3">
                            <pre
                                class="mb-0"
                            ><code class="text-muted small">// Define TODO model with REST endpoint
class Todo extends RestModel {
    static endpoint = "/api/example/todo";

    getStatusBadge() {
        const classes = {
            'ticket': 'badge bg-info',
            'task': 'badge bg-success',
            'bug': 'badge bg-danger'
        };
        return `&lt;span class="${classes[this.get('kind')] || 'badge bg-secondary'}"&gt;${this.get('kind')}&lt;/span&gt;`;
    }
}

// Define TODO collection with REST API integration
class TodoCollection extends DataList {
    constructor() {
        super(Todo, {
            endpoint: "http://0.0.0.0:8881/api/example/todo"
            // restEnabled automatically set to true due to endpoint
            // Custom fetch() override handles size/start API parameters
        });
    }
}

// Configure table with Collection class
const tableConfig = {
    container: '#todos-table-container',
    Collection: TodoCollection,
    columns: [
        { key: 'id', title: 'ID', sortable: true },
        { key: 'name', title: 'Name', sortable: true },
        { key: 'kind', title: 'Type', render: (item) => item.getStatusBadge() },
        { key: 'description', title: 'Description', searchable: true },
        { key: 'note.name', title: 'Note', searchable: true }
    ],
    searchable: true,
    sortable: true,
    paginated: true
};

// Initialize table with explicit data loading
const table = new Table(tableConfig);
await table.initializeData();  // Load initial data from REST API
await table.render();          // Render HTML with data

// Pagination automatically handles server-side fetching</code></pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bootstrap JavaScript -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

        <!-- Application Script -->
        <script type="module">
            import MOJO, { RestModel, DataList, Table } from "../../src/mojo.js";

            // Configuration
            const API_BASE = "http://0.0.0.0:8881";
            const API_ENDPOINT = "/api/example/todo";

            // State tracking
            let todoTable = null;
            let showNotes = true;

            /**
             * TODO Model - represents a single TODO item from the REST API
             */
            class Todo extends RestModel {
                static endpoint = API_ENDPOINT;

                constructor(data) {
                    super(data);
                }

                getStatusBadge() {
                    const classes = {
                        ticket: "badge bg-info text-white",
                        task: "badge bg-success text-white",
                        bug: "badge bg-danger text-white",
                        feature: "badge bg-primary text-white",
                    };
                    const kind = this.get("kind");
                    return `<span class="${classes[kind] || "badge bg-secondary text-white"}">${kind}</span>`;
                }

                getShortDescription() {
                    const description = this.get("description");
                    if (!description) return "";
                    return description.length > 100
                        ? description.substring(0, 100) + "..."
                        : description;
                }

                getNotePreview() {
                    const note = this.get("note");
                    if (!note || !note.name) return "-";
                    return note.name.length > 50 ? note.name.substring(0, 50) + "..." : note.name;
                }
            }

            /**
             * TODO Collection - manages multiple TODO items with REST API
             */
            class TodoCollection extends DataList {
                constructor() {
                    super(Todo, {
                        endpoint: `${API_BASE}${API_ENDPOINT}`,
                        // restEnabled automatically set to true due to endpoint
                    });
                }

                /**
                 * Override fetch to use correct API parameters (size/start instead of per_page/page)
                 * Our TODO API expects: size/start parameters instead of page/per_page
                 */
                async fetch(options = {}) {
                    console.log("ðŸ” [DEBUG] TodoCollection.fetch called with options:", options);
                    console.log("ðŸ” [DEBUG] Endpoint:", this.endpoint);
                    console.log("ðŸ” [DEBUG] REST enabled:", this.restEnabled);

                    // Call parent class fetch check (handles restEnabled flag)
                    if (!this.restEnabled) {
                        console.info("TodoCollection: REST disabled, skipping fetch");
                        return this;
                    }

                    if (this.options.preloaded && this.models.length > 0) {
                        console.info("TodoCollection: Using preloaded data, skipping fetch");
                        return this;
                    }

                    // Build URL with API-specific parameters (size/start)
                    let url = this.endpoint;
                    const params = new URLSearchParams();

                    // Convert standard pagination to API format
                    if (options.page || options.per_page || options.size || options.start) {
                        const page = options.page || 1;
                        const pageSize = options.per_page || options.size || 10;
                        const start = options.start || (page - 1) * pageSize;

                        params.append("size", pageSize.toString());
                        params.append("start", start.toString());
                    }

                    // Add other parameters
                    if (options.params) {
                        Object.keys(options.params).forEach((key) => {
                            if (key !== "page" && key !== "per_page") {
                                params.append(key, options.params[key]);
                            }
                        });
                    }

                    if (params.toString()) {
                        url += "?" + params.toString();
                    }

                    this.loading = true;
                    this.errors = {};

                    try {
                        const response = await this.constructor.Rest.GET(url);
                        console.log("ðŸ” [DEBUG] API Response received:", response);
                        console.log(
                            "ðŸ” [DEBUG] Response data length:",
                            response.data?.data?.length,
                        );

                        if (response.success !== false) {
                            // Parse API response format
                            const data = response.data.data || [];

                            // Store metadata for server-side pagination
                            this.meta = {
                                total: response.data.count || data.length,
                                page:
                                    Math.floor(
                                        (response.data.start || 0) / (response.data.size || 10),
                                    ) + 1,
                                per_page: response.data.size || 10,
                                start: response.data.start || 0,
                                size: response.data.size || 10,
                                count: response.data.count || data.length,
                            };

                            // Reset and add models to collection
                            this.reset();
                            this.add(data, { silent: options.silent });

                            return this;
                        } else {
                            this.errors = response.errors || {};
                            throw new Error(response.message || "Failed to fetch todos");
                        }
                    } catch (error) {
                        console.error("TodoCollection fetch error:", error);
                        this.errors = { fetch: error.message };
                        throw error;
                    } finally {
                        this.loading = false;
                    }
                }

                getByKind(kind) {
                    return this.filter((todo) => todo.get("kind") === kind);
                }

                getTicketCount() {
                    return this.getByKind("ticket").length;
                }
            }

            /**
             * Initialize the table with TODO data
             */
            async function initializeTodoTable() {
                try {
                    updateStatus("Initializing TODO table...", "info");

                    // Configure base columns
                    const baseColumns = [
                        {
                            key: "id",
                            title: "ID",
                            sortable: true,
                            searchable: false,
                        },
                        {
                            key: "name",
                            title: "TODO Name",
                            sortable: true,
                            searchable: true,
                        },
                        {
                            key: "kind",
                            title: "Type",
                            sortable: true,
                            searchable: true,
                            render: (item) => item.getStatusBadge(),
                        },
                        {
                            key: "description",
                            title: "Description",
                            searchable: true,
                            render: (item) =>
                                `<span class="text-muted">${item.getShortDescription()}</span>`,
                        },
                    ];

                    // Add notes column if enabled
                    if (showNotes) {
                        baseColumns.push({
                            key: "note.name",
                            title: "Related Note",
                            searchable: true,
                            render: (item) =>
                                `<small class="text-muted">${item.getNotePreview()}</small>`,
                        });
                    }

                    // Configure table - let Table handle data fetching
                    const tableConfig = {
                        container: "#todos-table-container",
                        Collection: TodoCollection,
                        columns: baseColumns,
                        searchable: true,
                        sortable: true,
                        paginated: true,
                        bordered: true,
                        hover: true,
                        striped: false,
                    };

                    // Initialize table
                    console.log("ðŸ” [DEBUG] Creating table with config:", tableConfig);
                    console.log("ðŸ” [DEBUG] TodoCollection test:", new TodoCollection());

                    todoTable = new Table(tableConfig);
                    console.log("ðŸ” [DEBUG] Table created:", todoTable);
                    console.log("ðŸ” [DEBUG] Table collection:", todoTable.collection);

                    // Load initial data explicitly
                    console.log("ðŸ” [DEBUG] Initializing table data...");
                    await todoTable.initializeData();

                    // Render the table with loaded data
                    await todoTable.render();
                    console.log("ðŸ” [DEBUG] Table rendered. Collection state:", {
                        hasCollection: !!todoTable.collection,
                        collectionLength: todoTable.collection?.length(),
                        collectionModels: todoTable.collection?.models?.length,
                        collectionMeta: todoTable.collection?.meta,
                    });

                    // Check if data was loaded successfully
                    if (todoTable.collection && todoTable.collection.length() > 0) {
                        const count = todoTable.collection.length();
                        const total = todoTable.collection.meta?.total || count;

                        updateStatus(
                            `Successfully loaded ${count} of ${total} TODO items`,
                            "success",
                        );
                        document.getElementById("record-count").textContent = total;
                        document.getElementById("last-updated").textContent =
                            new Date().toLocaleTimeString();
                    } else {
                        updateStatus("Table initialized, waiting for data...", "info");
                    }
                } catch (error) {
                    console.error("Failed to initialize TODO table:", error);
                    updateStatus(`Failed to load data: ${error.message}`, "danger");
                }
            }

            /**
             * Update the status indicator
             */
            function updateStatus(message, type = "info") {
                const statusEl = document.getElementById("api-status");
                const iconClass =
                    type === "success"
                        ? "bi-check-circle"
                        : type === "danger"
                          ? "bi-exclamation-triangle"
                          : "bi-info-circle";

                statusEl.className = `alert alert-${type} py-2 mb-2`;
                statusEl.innerHTML = `
                    <div class="d-flex align-items-center">
                        <i class="bi ${iconClass} me-2"></i>
                        <span>${message}</span>
                    </div>
                `;
            }

            /**
             * Refresh table data
             */
            async function refreshData() {
                const refreshBtn = document.getElementById("refresh-btn");
                refreshBtn.disabled = true;
                refreshBtn.innerHTML =
                    '<i class="bi bi-arrow-clockwise me-1 spinner-border spinner-border-sm"></i> Refreshing...';

                try {
                    // Use table's built-in refresh method
                    if (todoTable && todoTable.collection) {
                        await todoTable.collection.fetch();
                        await todoTable.render();

                        const count = todoTable.collection.length();
                        const total = todoTable.collection.meta?.total || count;
                        document.getElementById("record-count").textContent = total;
                        document.getElementById("last-updated").textContent =
                            new Date().toLocaleTimeString();
                        updateStatus(
                            `Refreshed: ${count} of ${total} TODO items loaded`,
                            "success",
                        );
                    }
                } catch (error) {
                    updateStatus(`Refresh failed: ${error.message}`, "danger");
                } finally {
                    refreshBtn.disabled = false;
                    refreshBtn.innerHTML =
                        '<i class="bi bi-arrow-clockwise me-1"></i> Refresh Data';
                }
            }

            /**
             * Toggle notes column visibility
             */
            async function toggleNotesColumn() {
                showNotes = !showNotes;
                const toggleBtn = document.getElementById("toggle-notes");
                toggleBtn.innerHTML = showNotes
                    ? '<i class="bi bi-eye me-1"></i> Hide Notes'
                    : '<i class="bi bi-eye-slash me-1"></i> Show Notes';

                // Re-initialize table with updated columns
                await initializeTodoTable();
            }

            // Event listeners
            document.getElementById("refresh-btn").addEventListener("click", refreshData);
            document.getElementById("toggle-notes").addEventListener("click", toggleNotesColumn);

            // Initialize the application
            document.addEventListener("DOMContentLoaded", async () => {
                // Initialize MOJO framework
                const app = new MOJO({
                    container: "body",
                    debug: true,
                    router: {
                        enabled: false,
                    },
                });

                // Configure REST client with API base URL
                app.rest.configure({
                    baseURL: API_BASE,
                    timeout: 10000,
                });

                // Initialize the TODO table
                await initializeTodoTable();
            });
        </script>
    </body>
</html>
