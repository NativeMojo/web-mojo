<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>MOJO Phase 2 Basic Example</title>

        <!-- Bootstrap CSS -->
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
            rel="stylesheet"
        />
        <!-- Bootstrap Icons -->
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
            rel="stylesheet"
        />

        <!-- Import Map for ES Modules -->
        <script type="importmap">
            {
                "imports": {
                    "mustache": "https://cdn.jsdelivr.net/npm/mustache@4.2.0/mustache.mjs"
                }
            }
        </script>
    </head>
    <body class="bg-light">
        <div class="container-fluid py-2">
            <!-- Header -->
            <div class="row mb-2">
                <div class="col">
                    <h5 class="mb-1">
                        <i class="bi bi-database me-2 text-primary"></i>
                        MOJO Phase 2: Data Layer
                    </h5>
                    <p class="text-muted mb-0 small">
                        RestModel & DataList demonstration with CRUD, validation, and collections
                    </p>
                </div>
                <div class="col-auto">
                    <a href="../" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-arrow-left me-1"></i>
                        Back to Examples
                    </a>
                </div>
            </div>

            <!-- Statistics Row -->
            <div class="row mb-2">
                <div class="col-auto">
                    <small class="text-muted">Users:</small>
                    <span class="badge bg-primary" id="user-count">0</span>
                </div>
                <div class="col-auto">
                    <small class="text-muted">Active:</small>
                    <span class="badge bg-success" id="active-count">0</span>
                </div>
                <div class="col-auto">
                    <small class="text-muted">API Calls:</small>
                    <span class="badge bg-info" id="api-calls">0</span>
                </div>
                <div class="col-auto">
                    <small class="text-muted">Validations:</small>
                    <span class="badge bg-warning" id="validation-checks">0</span>
                </div>
                <div class="col-auto">
                    <small class="text-muted">Status:</small>
                    <span class="badge bg-secondary" id="status-badge">Loading...</span>
                </div>
            </div>

            <div class="row">
                <!-- Main Content -->
                <div class="col-lg-8">
                    <!-- User Management -->
                    <div class="card mb-2">
                        <div class="card-header py-2">
                            <h6 class="mb-0">
                                <i class="bi bi-person me-1"></i>
                                User Management (RestModel Demo)
                            </h6>
                        </div>
                        <div class="card-body p-2">
                            <div class="row mb-2">
                                <div class="col-md-6">
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button
                                            class="btn btn-primary"
                                            onclick="createRandomUser()"
                                        >
                                            <i class="bi bi-plus me-1"></i>Create
                                        </button>
                                        <button
                                            class="btn btn-success"
                                            onclick="validateCurrentUser()"
                                        >
                                            <i class="bi bi-check me-1"></i>Validate
                                        </button>
                                        <button
                                            class="btn btn-warning"
                                            onclick="updateCurrentUser()"
                                        >
                                            <i class="bi bi-pencil me-1"></i>Update
                                        </button>
                                        <button
                                            class="btn btn-danger"
                                            onclick="deleteCurrentUser()"
                                        >
                                            <i class="bi bi-trash me-1"></i>Delete
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text">
                                            <i class="bi bi-search"></i>
                                        </span>
                                        <input
                                            type="text"
                                            class="form-control form-control-sm"
                                            placeholder="Search users..."
                                            id="user-search"
                                            oninput="filterUsers()"
                                        />
                                    </div>
                                </div>
                            </div>

                            <!-- Current User Display -->
                            <div id="current-user" class="alert alert-light py-2 mb-2">
                                <small class="text-muted">
                                    <i class="bi bi-info-circle me-1"></i>
                                    No user selected. Click "Create" to start.
                                </small>
                            </div>

                            <!-- Users Collection Table -->
                            <div class="table-responsive">
                                <table class="table table-sm table-hover table-bordered mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th style="width: 5%">#</th>
                                            <th style="width: 25%">Name</th>
                                            <th style="width: 30%">Email</th>
                                            <th style="width: 10%">Age</th>
                                            <th style="width: 15%">Status</th>
                                            <th style="width: 15%">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="users-table">
                                        <tr>
                                            <td colspan="6" class="text-center text-muted py-3">
                                                <i class="bi bi-database me-1"></i>
                                                No users loaded. Click "Load Sample Data" to start.
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- API Client Demo -->
                    <div class="card mb-2">
                        <div class="card-header py-2">
                            <h6 class="mb-0">
                                <i class="bi bi-cloud me-1"></i>
                                REST Client Demo
                            </h6>
                        </div>
                        <div class="card-body p-2">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="btn-group btn-group-sm mb-2" role="group">
                                        <button class="btn btn-outline-primary" onclick="testGet()">
                                            <i class="bi bi-download me-1"></i>GET
                                        </button>
                                        <button
                                            class="btn btn-outline-success"
                                            onclick="testPost()"
                                        >
                                            <i class="bi bi-upload me-1"></i>POST
                                        </button>
                                        <button class="btn btn-outline-warning" onclick="testPut()">
                                            <i class="bi bi-arrow-repeat me-1"></i>PUT
                                        </button>
                                        <button
                                            class="btn btn-outline-danger"
                                            onclick="testDelete()"
                                        >
                                            <i class="bi bi-trash me-1"></i>DELETE
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <button
                                        class="btn btn-sm btn-outline-secondary"
                                        onclick="clearApiLog()"
                                    >
                                        <i class="bi bi-x-circle me-1"></i>Clear Log
                                    </button>
                                </div>
                            </div>
                            <div
                                id="api-console"
                                class="bg-dark text-light p-2 rounded small"
                                style="height: 120px; overflow-y: auto; font-family: monospace"
                            >
                                <div class="text-success">$ API Console Ready</div>
                                <div class="text-muted">
                                    $ Click HTTP method buttons to test API client
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sidebar -->
                <div class="col-lg-4">
                    <!-- Collection Actions -->
                    <div class="card mb-2">
                        <div class="card-header py-2">
                            <h6 class="mb-0">
                                <i class="bi bi-collection me-1"></i>
                                Collection Actions
                            </h6>
                        </div>
                        <div class="card-body p-2">
                            <div class="d-grid gap-1">
                                <button class="btn btn-sm btn-primary" onclick="loadSampleData()">
                                    <i class="bi bi-database-add me-1"></i>Load Sample Data
                                </button>
                                <button class="btn btn-sm btn-success" onclick="showActiveUsers()">
                                    <i class="bi bi-funnel me-1"></i>Filter Active
                                </button>
                                <button class="btn btn-sm btn-info" onclick="sortUsersByName()">
                                    <i class="bi bi-sort-alpha-down me-1"></i>Sort by Name
                                </button>
                                <button class="btn btn-sm btn-warning" onclick="sortUsersByAge()">
                                    <i class="bi bi-sort-numeric-down me-1"></i>Sort by Age
                                </button>
                                <button class="btn btn-sm btn-secondary" onclick="clearAllUsers()">
                                    <i class="bi bi-trash me-1"></i>Clear All
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Validation Rules -->
                    <div class="card mb-2">
                        <div class="card-header py-2">
                            <h6 class="mb-0">
                                <i class="bi bi-shield-check me-1"></i>
                                Validation Rules
                            </h6>
                        </div>
                        <div class="card-body p-2">
                            <table class="table table-sm table-borderless mb-0 small">
                                <tr>
                                    <td class="text-muted">Name:</td>
                                    <td>Required, 2-50 chars</td>
                                </tr>
                                <tr>
                                    <td class="text-muted">Email:</td>
                                    <td>Required, valid format</td>
                                </tr>
                                <tr>
                                    <td class="text-muted">Age:</td>
                                    <td>Number, 13-120</td>
                                </tr>
                                <tr>
                                    <td class="text-muted">Active:</td>
                                    <td>Boolean, default true</td>
                                </tr>
                            </table>
                        </div>
                    </div>

                    <!-- Activity Log -->
                    <div class="card mb-2">
                        <div
                            class="card-header py-2 d-flex justify-content-between align-items-center"
                        >
                            <h6 class="mb-0">
                                <i class="bi bi-activity me-1"></i>
                                Activity Log
                            </h6>
                            <button
                                class="btn btn-sm btn-link p-0 text-decoration-none"
                                onclick="clearActivityLog()"
                            >
                                <i class="bi bi-x"></i>
                            </button>
                        </div>
                        <div class="card-body p-0">
                            <div
                                id="activity-log"
                                class="small"
                                style="max-height: 200px; overflow-y: auto"
                            >
                                <div class="p-2 text-muted">
                                    <i class="bi bi-info-circle me-1"></i>
                                    Activity will be logged here...
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Model Info -->
                    <div class="card">
                        <div class="card-header py-2">
                            <h6 class="mb-0">
                                <i class="bi bi-gear me-1"></i>
                                Model Information
                            </h6>
                        </div>
                        <div class="card-body p-2">
                            <table class="table table-sm table-borderless mb-0 small">
                                <tr>
                                    <td class="text-muted">RestModel:</td>
                                    <td>User</td>
                                </tr>
                                <tr>
                                    <td class="text-muted">DataList:</td>
                                    <td>Users</td>
                                </tr>
                                <tr>
                                    <td class="text-muted">Endpoint:</td>
                                    <td>/api/users</td>
                                </tr>
                                <tr>
                                    <td class="text-muted">Validation:</td>
                                    <td class="text-success">Enabled</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Reference -->
            <div class="row mt-2">
                <div class="col">
                    <div class="alert alert-info py-2 mb-1">
                        <h6 class="alert-heading mb-1">
                            <i class="bi bi-lightbulb me-1"></i>
                            Phase 2 Features Demonstrated
                        </h6>
                        <div class="row small">
                            <div class="col-md-6">
                                <strong>RestModel:</strong> CRUD operations, validation, lifecycle
                                methods<br />
                                <strong>DataList:</strong> Collection management, querying, event
                                handling
                            </div>
                            <div class="col-md-6">
                                <strong>Validation:</strong> Real-time validation with custom
                                rules<br />
                                <strong>REST Client:</strong> HTTP methods, request/response
                                handling
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bootstrap JS -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

        <!-- Application Logic -->
        <script type="module">
            import MOJO, { RestModel, DataList } from "../../src/mojo.js";

            // State tracking
            let apiCallCount = 0;
            let validationCount = 0;
            let currentUser = null;
            let userCollection = null;

            // Sample data
            const sampleUsers = [
                { id: 1, name: "John Doe", email: "john@example.com", age: 30, active: true },
                { id: 2, name: "Jane Smith", email: "jane@example.com", age: 25, active: true },
                { id: 3, name: "Bob Wilson", email: "bob@example.com", age: 35, active: false },
                { id: 4, name: "Alice Brown", email: "alice@example.com", age: 28, active: true },
                {
                    id: 5,
                    name: "Charlie Davis",
                    email: "charlie@example.com",
                    age: 42,
                    active: false,
                },
            ];

            // User Model
            class User extends RestModel {
                static endpoint = "/api/users";
                static validations = {
                    name: { required: true, minLength: 2, maxLength: 50 },
                    email: { required: true, pattern: /^[^\s@]+@[^\s@]+\.[^\s@]+$/ },
                    age: { type: "number", min: 13, max: 120 },
                    active: { type: "boolean", default: true },
                };

                getFullName() {
                    return `${this.data.name} (${this.data.email})`;
                }

                async activate() {
                    this.data.active = true;
                    return await this.save();
                }
            }

            // Users Collection
            class Users extends DataList {
                constructor() {
                    super(User, {
                        endpoint: "/api/users",
                        // restEnabled automatically set to true due to endpoint
                    });
                }

                getActiveUsers() {
                    return this.filter((user) => user.data.active);
                }

                async fetchWithPagination(page = 1, limit = 10) {
                    const params = { page, limit };
                    return await this.fetchAll(params);
                }
            }

            // Utility functions
            function updateStats() {
                document.getElementById("user-count").textContent = userCollection
                    ? userCollection.length
                    : 0;
                document.getElementById("active-count").textContent = userCollection
                    ? userCollection.getActiveUsers().length
                    : 0;
                document.getElementById("api-calls").textContent = apiCallCount;
                document.getElementById("validation-checks").textContent = validationCount;
            }

            function logActivity(message, type = "info") {
                const log = document.getElementById("activity-log");
                const timestamp = new Date().toLocaleTimeString();
                const icons = {
                    info: "info-circle",
                    success: "check-circle",
                    warning: "exclamation-triangle",
                    error: "x-circle",
                };
                const colors = {
                    info: "text-info",
                    success: "text-success",
                    warning: "text-warning",
                    error: "text-danger",
                };

                const entry = document.createElement("div");
                entry.className = "p-2 border-bottom";
                entry.innerHTML = `
                    <div class="d-flex align-items-start">
                        <i class="bi bi-${icons[type]} me-2 ${colors[type]}"></i>
                        <div>
                            <div>${message}</div>
                            <div class="text-muted" style="font-size: 0.75rem;">${timestamp}</div>
                        </div>
                    </div>
                `;

                log.appendChild(entry);
                log.scrollTop = log.scrollHeight;
            }

            function logApi(message) {
                const console = document.getElementById("api-console");
                const timestamp = new Date().toLocaleTimeString();
                console.innerHTML += `\n<div class="text-info">[${timestamp}] ${message}</div>`;
                console.scrollTop = console.scrollHeight;
            }

            function updateUsersTable() {
                const tbody = document.getElementById("users-table");
                if (!userCollection || userCollection.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center text-muted py-3">
                                <i class="bi bi-database me-1"></i>
                                No users to display
                            </td>
                        </tr>
                    `;
                    return;
                }

                const searchTerm = document.getElementById("user-search").value.toLowerCase();
                const filteredUsers = userCollection.items.filter(
                    (user) =>
                        user.data.name.toLowerCase().includes(searchTerm) ||
                        user.data.email.toLowerCase().includes(searchTerm),
                );

                tbody.innerHTML = filteredUsers
                    .map(
                        (user) => `
                    <tr class="${user.data.active ? "" : "table-warning"}">
                        <td>${user.data.id}</td>
                        <td>${user.data.name}</td>
                        <td>${user.data.email}</td>
                        <td class="text-end">${user.data.age}</td>
                        <td>
                            <span class="badge ${user.data.active ? "bg-success" : "bg-secondary"}">
                                ${user.data.active ? "Active" : "Inactive"}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="selectUser(${user.data.id})">
                                <i class="bi bi-eye"></i>
                            </button>
                        </td>
                    </tr>
                `,
                    )
                    .join("");
            }

            function updateCurrentUser() {
                const container = document.getElementById("current-user");
                if (!currentUser) {
                    container.className = "alert alert-light py-2 mb-2";
                    container.innerHTML = `
                        <small class="text-muted">
                            <i class="bi bi-info-circle me-1"></i>
                            No user selected. Click "Create" to start.
                        </small>
                    `;
                    return;
                }

                const isValid = currentUser.validate();
                container.className = `alert ${isValid ? "alert-success" : "alert-danger"} py-2 mb-2`;
                container.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <strong>${currentUser.data.name}</strong><br>
                            <small>${currentUser.data.email} ‚Ä¢ Age: ${currentUser.data.age}</small>
                        </div>
                        <div class="text-end">
                            <span class="badge ${currentUser.data.active ? "bg-success" : "bg-secondary"}">
                                ${currentUser.data.active ? "Active" : "Inactive"}
                            </span>
                            <br>
                            <small class="text-muted">ID: ${currentUser.data.id}</small>
                        </div>
                    </div>
                `;
            }

            // Global functions
            window.loadSampleData = function () {
                userCollection = new Users();
                sampleUsers.forEach((userData) => {
                    const user = new User(userData);
                    userCollection.add(user);
                });

                updateStats();
                updateUsersTable();
                logActivity(`Loaded ${sampleUsers.length} sample users`, "success");
            };

            window.createRandomUser = function () {
                const names = ["Alex Johnson", "Sam Wilson", "Taylor Brown", "Morgan Davis"];
                const domains = ["example.com", "test.com", "demo.com"];
                const name = names[Math.floor(Math.random() * names.length)];
                const email =
                    name.toLowerCase().replace(" ", ".") +
                    "@" +
                    domains[Math.floor(Math.random() * domains.length)];

                currentUser = new User({
                    id: Date.now(),
                    name: name,
                    email: email,
                    age: Math.floor(Math.random() * 40) + 20,
                    active: Math.random() > 0.3,
                });

                if (userCollection) {
                    userCollection.add(currentUser);
                    updateUsersTable();
                }

                updateCurrentUser();
                updateStats();
                logActivity(`Created user: ${currentUser.data.name}`, "success");
            };

            window.validateCurrentUser = function () {
                if (!currentUser) {
                    logActivity("No user to validate", "warning");
                    return;
                }

                validationCount++;
                const isValid = currentUser.validate();
                const errors = currentUser.getValidationErrors();

                updateCurrentUser();
                updateStats();

                if (isValid) {
                    logActivity("User validation passed", "success");
                } else {
                    logActivity(`Validation failed: ${Object.keys(errors).join(", ")}`, "error");
                }
            };

            window.updateCurrentUser = function () {
                if (!currentUser) {
                    logActivity("No user to update", "warning");
                    return;
                }

                const updates = {
                    age: Math.floor(Math.random() * 50) + 20,
                    active: Math.random() > 0.5,
                };

                Object.assign(currentUser.data, updates);
                updateCurrentUser();
                updateUsersTable();
                updateStats();
                logActivity(`Updated user: ${JSON.stringify(updates)}`, "info");
            };

            window.deleteCurrentUser = function () {
                if (!currentUser) {
                    logActivity("No user to delete", "warning");
                    return;
                }

                const userName = currentUser.data.name;
                if (userCollection) {
                    userCollection.remove(currentUser);
                    updateUsersTable();
                }

                currentUser = null;
                updateCurrentUser();
                updateStats();
                logActivity(`Deleted user: ${userName}`, "warning");
            };

            window.selectUser = function (id) {
                if (!userCollection) return;

                const user = userCollection.items.find((u) => u.data.id === id);
                if (user) {
                    currentUser = user;
                    updateCurrentUser();
                    logActivity(`Selected user: ${user.data.name}`, "info");
                }
            };

            window.showActiveUsers = function () {
                if (!userCollection) {
                    logActivity("No collection loaded", "warning");
                    return;
                }

                const activeUsers = userCollection.getActiveUsers();
                document.getElementById("user-search").value = "";
                // Simple filter simulation
                logActivity(`Filtered to ${activeUsers.length} active users`, "info");
            };

            window.sortUsersByName = function () {
                if (!userCollection) return;

                const sorted = userCollection.sortBy("name");
                updateUsersTable();
                logActivity("Users sorted by name", "info");
            };

            window.sortUsersByAge = function () {
                if (!userCollection) return;

                const sorted = userCollection.sortBy("age");
                updateUsersTable();
                logActivity("Users sorted by age", "info");
            };

            window.clearAllUsers = function () {
                if (userCollection) {
                    userCollection.clear();
                    updateUsersTable();
                }
                currentUser = null;
                updateCurrentUser();
                updateStats();
                logActivity("All users cleared", "warning");
            };

            window.filterUsers = function () {
                updateUsersTable();
            };

            window.clearActivityLog = function () {
                const log = document.getElementById("activity-log");
                log.innerHTML =
                    '<div class="p-2 text-muted"><i class="bi bi-info-circle me-1"></i>Log cleared</div>';
            };

            // API testing functions
            window.testGet = function () {
                apiCallCount++;
                updateStats();
                logApi("GET /api/users ‚Üí 200 OK (5 users)");
            };

            window.testPost = function () {
                apiCallCount++;
                updateStats();
                logApi('POST /api/users ‚Üí 201 Created {"id": 6, "name": "New User"}');
            };

            window.testPut = function () {
                apiCallCount++;
                updateStats();
                logApi('PUT /api/users/1 ‚Üí 200 OK {"updated": true}');
            };

            window.testDelete = function () {
                apiCallCount++;
                updateStats();
                logApi("DELETE /api/users/1 ‚Üí 204 No Content");
            };

            window.clearApiLog = function () {
                const console = document.getElementById("api-console");
                console.innerHTML = '<div class="text-success">$ API Console Cleared</div>';
            };

            // Initialize
            document.addEventListener("DOMContentLoaded", function () {
                document.getElementById("status-badge").textContent = "Ready";
                document.getElementById("status-badge").className = "badge bg-success";

                logActivity("MOJO Phase 2 Data Layer initialized", "success");
                console.log("üóÉÔ∏è MOJO Phase 2 Basic Example Ready");
                console.log(
                    "Available functions: loadSampleData(), createRandomUser(), validateCurrentUser()",
                );
            });
        </script>
    </body>
</html>
