<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Image Editor Views - Phase 1 Testing</title>

        <!-- Bootstrap CSS -->
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
            rel="stylesheet"
        />
        <!-- Bootstrap Icons -->
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
            rel="stylesheet"
        />

        <style>
            .test-section {
                margin-bottom: 3rem;
                padding: 2rem;
                border: 2px dashed #dee2e6;
                border-radius: 10px;
            }
            .test-result {
                margin-top: 1rem;
                padding: 1rem;
                background: #f8f9fa;
                border-radius: 5px;
                font-family: monospace;
                white-space: pre-wrap;
                max-height: 200px;
                overflow-y: auto;
            }
            .result-image {
                margin-top: 1rem;
                max-width: 100%;
                max-height: 300px;
                border: 2px solid #dee2e6;
                border-radius: 5px;
                display: none;
            }
            .result-image.show {
                display: block;
            }
            .comparison-container {
                display: none;
                margin-top: 1rem;
            }
            .comparison-container.show {
                display: block;
            }
            .comparison-images {
                display: flex;
                gap: 1rem;
                align-items: flex-start;
            }
            .comparison-item {
                flex: 1;
                text-align: center;
            }
            .comparison-item img {
                max-width: 100%;
                max-height: 250px;
                border: 2px solid #dee2e6;
                border-radius: 5px;
            }
            .comparison-label {
                margin-top: 0.5rem;
                font-weight: bold;
                color: #495057;
            }
            .test-button {
                margin: 0.5rem;
            }
            .status-indicator {
                display: inline-block;
                width: 10px;
                height: 10px;
                border-radius: 50%;
                margin-right: 5px;
            }
            .status-success {
                background-color: #28a745;
            }
            .status-error {
                background-color: #dc3545;
            }
            .status-pending {
                background-color: #ffc107;
            }
        </style>
    </head>
    <body>
        <div class="container my-5">
            <h1 class="text-center mb-5">
                <i class="bi bi-bug"></i> Image Editor Views - Phase 1 Testing
            </h1>

            <div class="alert alert-info mb-5">
                <h5><i class="bi bi-info-circle"></i> Phase 1: Individual View Testing</h5>
                <p>
                    Testing each view component in isolation to ensure they work correctly before
                    integration.
                </p>
                <p class="mb-0">Each view should be able to:</p>
                <ul class="mb-0">
                    <li>Load and display an image</li>
                    <li>Perform its specific operations</li>
                    <li>Export the modified image data</li>
                    <li>Clean up properly when closed</li>
                </ul>
            </div>

            <!-- Test Image Selection -->
            <div class="test-section">
                <h3><i class="bi bi-image"></i> Test Image</h3>
                <div class="row">
                    <div class="col-md-6">
                        <label for="imageUrl" class="form-label">Image URL:</label>
                        <input
                            type="text"
                            class="form-control"
                            id="imageUrl"
                            value="./portal/media/monkey.png"
                            placeholder="Enter image URL or path"
                        />
                        <small class="text-muted">You can use a URL or local path</small>
                    </div>
                    <div class="col-md-6">
                        <img
                            id="previewImage"
                            src="./portal/media/monkey.png"
                            alt="Test Image"
                            class="img-thumbnail"
                            style="max-height: 150px"
                        />
                    </div>
                </div>
            </div>

            <!-- ImageTransformView Test -->
            <div class="test-section">
                <h3><i class="bi bi-arrows-move"></i> ImageTransformView Test</h3>
                <p>Tests zoom, pan, and rotation functionality</p>

                <div>
                    <button class="btn btn-primary test-button" onclick="testTransformView()">
                        <i class="bi bi-play"></i> Test Transform View
                    </button>
                    <button
                        class="btn btn-secondary test-button"
                        onclick="testTransformViewCustom()"
                    >
                        <i class="bi bi-gear"></i> Test with Custom Options
                    </button>
                </div>

                <div id="transformResult" class="test-result d-none">
                    <span class="status-indicator status-pending"></span>
                    Waiting for test...
                </div>

                <div id="transformComparison" class="comparison-container">
                    <div class="comparison-images">
                        <div class="comparison-item">
                            <img id="transformOriginal" alt="Original" />
                            <div class="comparison-label">Original</div>
                        </div>
                        <div class="comparison-item">
                            <img id="transformResultImage" alt="Transform Result" />
                            <div class="comparison-label">After Transform</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ImageCropView Test -->
            <div class="test-section">
                <h3><i class="bi bi-crop"></i> ImageCropView Test</h3>
                <p>Tests crop selection and application</p>

                <div>
                    <button class="btn btn-success test-button" onclick="testCropView()">
                        <i class="bi bi-play"></i> Test Crop View
                    </button>
                    <button class="btn btn-secondary test-button" onclick="testCropViewFixed()">
                        <i class="bi bi-aspect-ratio"></i> Test Fixed Aspect Ratio (16:9)
                    </button>
                    <button class="btn btn-warning test-button" onclick="testCropViewFixedSize()">
                        <i class="bi bi-bounding-box"></i> Test Fixed Size (50x50px)
                    </button>
                    <button class="btn btn-info test-button" onclick="testCropViewCropAndScale()">
                        <i class="bi bi-aspect-ratio"></i> Test Crop & Scale (128x128px)
                    </button>
                </div>

                <div id="cropResult" class="test-result d-none">
                    <span class="status-indicator status-pending"></span>
                    Waiting for test...
                </div>

                <div id="cropComparison" class="comparison-container">
                    <div class="comparison-images">
                        <div class="comparison-item">
                            <img id="cropOriginal" alt="Original" />
                            <div class="comparison-label">Original</div>
                        </div>
                        <div class="comparison-item">
                            <img id="cropResultImage" alt="Crop Result" />
                            <div class="comparison-label">After Crop</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ImageFiltersView Test -->
            <div class="test-section">
                <h3><i class="bi bi-palette"></i> ImageFiltersView Test</h3>
                <p>Tests filter application (brightness, contrast, etc.)</p>

                <div>
                    <button class="btn btn-info test-button" onclick="testFiltersView()">
                        <i class="bi bi-play"></i> Test Filters View
                    </button>
                    <button
                        class="btn btn-secondary test-button"
                        onclick="testFiltersViewMinimal()"
                    >
                        <i class="bi bi-sliders"></i> Test Minimal Controls
                    </button>
                </div>

                <div id="filtersResult" class="test-result d-none">
                    <span class="status-indicator status-pending"></span>
                    Waiting for test...
                </div>

                <div id="filtersComparison" class="comparison-container">
                    <div class="comparison-images">
                        <div class="comparison-item">
                            <img id="filtersOriginal" alt="Original" />
                            <div class="comparison-label">Original</div>
                        </div>
                        <div class="comparison-item">
                            <img id="filtersResultImage" alt="Filters Result" />
                            <div class="comparison-label">After Filters</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Integration Test Preview -->
            <div class="test-section">
                <h3><i class="bi bi-layers"></i> Sequential Processing Test</h3>
                <p>Test applying multiple operations in sequence</p>

                <button class="btn btn-warning test-button" onclick="testSequential()">
                    <i class="bi bi-arrow-right-circle"></i> Test Sequential Processing
                </button>

                <div id="sequentialResult" class="test-result d-none">
                    <span class="status-indicator status-pending"></span>
                    Waiting for test...
                </div>

                <div class="row mt-3">
                    <div class="col-md-4">
                        <h6>After Transform:</h6>
                        <img
                            id="sequentialTransformImage"
                            class="result-image show w-100"
                            alt="After Transform"
                        />
                    </div>
                    <div class="col-md-4">
                        <h6>After Crop:</h6>
                        <img
                            id="sequentialCropImage"
                            class="result-image show w-100"
                            alt="After Crop"
                        />
                    </div>
                    <div class="col-md-4">
                        <h6>After Filters:</h6>
                        <img
                            id="sequentialFiltersImage"
                            class="result-image show w-100"
                            alt="After Filters"
                        />
                    </div>
                </div>
            </div>

            <!-- Test Results Summary -->
            <div class="test-section">
                <h3><i class="bi bi-clipboard-check"></i> Test Results Summary</h3>
                <div id="testSummary" class="test-result">No tests run yet.</div>
            </div>
        </div>

        <!-- Bootstrap JS -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

        <!-- MOJO Framework -->
        <script type="module">
            import ImageTransformView from "../src/lightbox/ImageTransformView.js";
            import ImageCropView from "../src/lightbox/ImageCropView.js";
            import ImageFiltersView from "../src/lightbox/ImageFiltersView.js";

            // Make views available globally for testing
            window.ImageTransformView = ImageTransformView;
            window.ImageCropView = ImageCropView;
            window.ImageFiltersView = ImageFiltersView;

            // Test results tracking
            window.testResults = {
                transform: null,
                crop: null,
                filters: null,
                sequential: null,
            };

            // Helper functions
            window.getTestImageUrl = function () {
                return document.getElementById("imageUrl").value || "./portal/media/monkey.png";
            };

            window.updateResult = function (elementId, status, message) {
                const element = document.getElementById(elementId);
                element.classList.remove("d-none");
                const indicator = element.querySelector(".status-indicator");
                indicator.className = "status-indicator status-" + status;
                element.innerHTML = `<span class="status-indicator status-${status}"></span>${message}`;
                updateSummary();
            };

            window.showResultImage = function (imageId, dataUrl, comparisonId) {
                console.log("showResultImage called with:", {
                    imageId,
                    dataUrl: dataUrl ? `${dataUrl.substring(0, 50)}...` : "null",
                    comparisonId,
                });

                const img = document.getElementById(imageId);
                console.log("Found img element:", !!img, img);

                if (img && dataUrl) {
                    console.log("Setting img.src to dataUrl");
                    img.src = dataUrl;
                    img.style.display = "block";
                    console.log("Image src set, should be visible now");

                    // Show comparison container if provided
                    if (comparisonId) {
                        const comparison = document.getElementById(comparisonId);
                        if (comparison) {
                            comparison.classList.add("show");

                            // Set original image
                            const originalImg = comparison.querySelector('[id$="Original"]');
                            if (originalImg) {
                                originalImg.src = getTestImageUrl();
                            }
                        }
                    }
                } else if (img) {
                    console.log("Hiding image - no dataUrl provided");
                    img.style.display = "none";
                    // Hide comparison container if provided
                    if (comparisonId) {
                        const comparison = document.getElementById(comparisonId);
                        if (comparison) {
                            comparison.classList.remove("show");
                        }
                    }
                } else {
                    console.log("No img element found with ID:", imageId);
                }
            };

            window.updateSummary = function () {
                const summary = document.getElementById("testSummary");
                let html = "Test Results:\n\n";
                for (const [test, result] of Object.entries(window.testResults)) {
                    if (result) {
                        html += `✓ ${test}: ${result.status} - ${result.message}\n`;
                    } else {
                        html += `○ ${test}: Not tested\n`;
                    }
                }
                summary.textContent = html;
            };

            // Update preview when URL changes
            document.getElementById("imageUrl").addEventListener("change", function (e) {
                document.getElementById("previewImage").src = e.target.value;
            });

            // Test functions
            window.testTransformView = async function () {
                try {
                    console.log("Starting ImageTransformView test...");
                    updateResult("transformResult", "pending", "Opening transform dialog...");

                    const result = await ImageTransformView.showDialog(getTestImageUrl(), {
                        title: "Transform Test",
                        size: "md",
                        allowPan: true,
                        allowZoom: true,
                        allowRotate: true,
                    });

                    console.log("Transform result:", result);

                    if (result.action === "transform") {
                        const message = `Success! Transform applied.\nData URL: ${result.data ? result.data.substring(0, 50) + "..." : "No data"}\nTransform State: ${JSON.stringify(result.transformState, null, 2)}`;
                        updateResult("transformResult", "success", message);
                        showResultImage("transformResultImage", result.data, "transformComparison");
                        window.testResults.transform = {
                            status: "success",
                            message: "Transform applied successfully",
                        };
                    } else {
                        updateResult("transformResult", "pending", "Cancelled by user");
                        showResultImage("transformResultImage", null, "transformComparison");
                        window.testResults.transform = {
                            status: "cancelled",
                            message: "User cancelled",
                        };
                    }
                } catch (error) {
                    console.error("Transform test error:", error);
                    updateResult("transformResult", "error", `Error: ${error.message}`);
                    window.testResults.transform = { status: "error", message: error.message };
                }
            };

            window.testTransformViewCustom = async function () {
                try {
                    const result = await ImageTransformView.showDialog(getTestImageUrl(), {
                        title: "Custom Transform Test",
                        allowPan: true,
                        allowZoom: false,
                        allowRotate: true,
                        size: "lg",
                    });

                    if (result.action === "transform") {
                        updateResult(
                            "transformResult",
                            "success",
                            "Custom transform applied successfully",
                        );
                        showResultImage("transformResultImage", result.data, "transformComparison");
                    } else {
                        updateResult("transformResult", "pending", "Cancelled");
                        showResultImage("transformResultImage", null, "transformComparison");
                    }
                } catch (error) {
                    updateResult("transformResult", "error", `Error: ${error.message}`);
                }
            };

            window.testCropView = async function () {
                try {
                    console.log("Starting ImageCropView test...");
                    updateResult("cropResult", "pending", "Opening crop dialog...");

                    const result = await ImageCropView.showDialog(getTestImageUrl(), {
                        title: "Crop Test",
                        showGrid: true,
                        size: "lg",
                        autoFit: true,
                        aspectRatio: 1,
                        minCropSize: 50,
                        maxCropSize: 50,
                    });

                    console.log("Crop result:", result);

                    if (result.action === "crop") {
                        const message = `Success! Crop applied.\nData URL: ${result.data ? result.data.substring(0, 50) + "..." : "No data"}\nCrop Data: ${JSON.stringify(result.cropData, null, 2)}`;
                        updateResult("cropResult", "success", message);
                        showResultImage("cropResultImage", result.data, "cropComparison");
                        window.testResults.crop = {
                            status: "success",
                            message: "Crop applied successfully",
                        };
                    } else {
                        updateResult("cropResult", "pending", "Cancelled by user");
                        showResultImage("cropResultImage", null, "cropComparison");
                        window.testResults.crop = {
                            status: "cancelled",
                            message: "User cancelled",
                        };
                    }
                } catch (error) {
                    console.error("Crop test error:", error);
                    updateResult("cropResult", "error", `Error: ${error.message}`);
                    window.testResults.crop = { status: "error", message: error.message };
                }
            };

            window.testCropViewFixed = async function () {
                try {
                    const result = await ImageCropView.showDialog(getTestImageUrl(), {
                        title: "Fixed Aspect Ratio Crop Test",
                        aspectRatio: 16 / 9,
                        size: "lg",
                        showGrid: true,
                    });

                    if (result.action === "crop") {
                        updateResult(
                            "cropResult",
                            "success",
                            "Fixed aspect ratio crop applied successfully",
                        );
                        showResultImage("cropResultImage", result.data, "cropComparison");
                    } else {
                        updateResult("cropResult", "pending", "Cancelled");
                        showResultImage("cropResultImage", null, "cropComparison");
                    }
                } catch (error) {
                    updateResult("cropResult", "error", `Error: ${error.message}`);
                }
            };

            window.testCropViewFixedSize = async function () {
                try {
                    const result = await ImageCropView.showDialog(getTestImageUrl(), {
                        title: "Fixed Size Crop Test (50x50px)",
                        size: "lg",
                        fixedCropSize: { width: 50, height: 50 },
                        showGrid: true,
                    });

                    if (result.action === "crop") {
                        updateResult(
                            "cropResult",
                            "success",
                            "Fixed size crop (50x50px) applied successfully",
                        );
                        showResultImage("cropResultImage", result.data, "cropComparison");
                    } else {
                        updateResult("cropResult", "pending", "Cancelled");
                        showResultImage("cropResultImage", null, "cropComparison");
                    }
                } catch (error) {
                    updateResult("cropResult", "error", `Error: ${error.message}`);
                }
            };

            window.testCropViewCropAndScale = async function () {
                try {
                    const result = await ImageCropView.showDialog(getTestImageUrl(), {
                        title: "Crop & Scale Test (128x128px output)",
                        size: "md",
                        cropAndScale: { width: 128, height: 128 },
                        showGrid: true,
                    });

                    if (result.action === "crop") {
                        updateResult(
                            "cropResult",
                            "success",
                            "Crop & scale (128x128px) applied successfully",
                        );
                        showResultImage("cropResultImage", result.data, "cropComparison");
                    } else {
                        updateResult("cropResult", "pending", "Cancelled");
                        showResultImage("cropResultImage", null, "cropComparison");
                    }
                } catch (error) {
                    updateResult("cropResult", "error", `Error: ${error.message}`);
                }
            };

            window.testFiltersView = async function () {
                try {
                    console.log("Starting ImageFiltersView test...");
                    updateResult("filtersResult", "pending", "Opening filters dialog...");

                    const result = await ImageFiltersView.showDialog(getTestImageUrl(), {
                        title: "Filters Test",
                        showControls: true,
                        size: "md",
                        allowReset: true,
                    });

                    console.log("Filters result:", result);

                    if (result.action === "filters") {
                        const message = `Success! Filters applied.\nData URL: ${result.data ? result.data.substring(0, 50) + "..." : "No data"}\nFilter State: ${JSON.stringify(result.filterState, null, 2)}`;
                        updateResult("filtersResult", "success", message);
                        showResultImage("filtersResultImage", result.data, "filtersComparison");
                        window.testResults.filters = {
                            status: "success",
                            message: "Filters applied successfully",
                        };
                    } else {
                        updateResult("filtersResult", "pending", "Cancelled by user");
                        showResultImage("filtersResultImage", null, "filtersComparison");
                        window.testResults.filters = {
                            status: "cancelled",
                            message: "User cancelled",
                        };
                    }
                } catch (error) {
                    console.error("Filters test error:", error);
                    updateResult("filtersResult", "error", `Error: ${error.message}`);
                    window.testResults.filters = { status: "error", message: error.message };
                }
            };

            window.testFiltersViewMinimal = async function () {
                try {
                    const result = await ImageFiltersView.showDialog(getTestImageUrl(), {
                        title: "Minimal Filters Test",
                        canvasSize: "md",
                        showControls: false,
                        allowReset: false,
                    });

                    if (result.action === "filters") {
                        updateResult(
                            "filtersResult",
                            "success",
                            "Minimal filters applied successfully",
                        );
                        showResultImage("filtersResultImage", result.data, "filtersComparison");
                    } else {
                        updateResult("filtersResult", "pending", "Cancelled");
                        showResultImage("filtersResultImage", null, "filtersComparison");
                    }
                } catch (error) {
                    updateResult("filtersResult", "error", `Error: ${error.message}`);
                }
            };

            window.testSequential = async function () {
                try {
                    updateResult("sequentialResult", "pending", "Starting sequential test...");
                    let currentImageData = getTestImageUrl();

                    // Step 1: Transform
                    updateResult("sequentialResult", "pending", "Step 1: Applying transform...");
                    const transformResult = await ImageTransformView.showDialog(currentImageData, {
                        title: "Step 1: Transform",
                    });

                    if (transformResult.action !== "transform") {
                        updateResult("sequentialResult", "pending", "Transform cancelled");
                        return;
                    }
                    currentImageData = transformResult.data;
                    showResultImage("sequentialTransformImage", transformResult.data);

                    // Step 2: Crop
                    updateResult("sequentialResult", "pending", "Step 2: Applying crop...");
                    const cropResult = await ImageCropView.showDialog(currentImageData, {
                        title: "Step 2: Crop (with transformed image)",
                    });

                    if (cropResult.action !== "crop") {
                        updateResult("sequentialResult", "pending", "Crop cancelled");
                        return;
                    }
                    currentImageData = cropResult.data;
                    showResultImage("sequentialCropImage", cropResult.data);

                    // Step 3: Filters
                    updateResult("sequentialResult", "pending", "Step 3: Applying filters...");
                    const filtersResult = await ImageFiltersView.showDialog(currentImageData, {
                        title: "Step 3: Filters (with transformed and cropped image)",
                    });

                    if (filtersResult.action !== "filters") {
                        updateResult("sequentialResult", "pending", "Filters cancelled");
                        return;
                    }
                    showResultImage("sequentialFiltersImage", filtersResult.data);

                    updateResult(
                        "sequentialResult",
                        "success",
                        "Sequential processing complete!\nAll three operations were applied successfully.\n" +
                            "The final image has been transformed, cropped, and filtered.",
                    );

                    window.testResults.sequential = {
                        status: "success",
                        message: "All operations applied in sequence",
                    };
                } catch (error) {
                    console.error("Sequential test error:", error);
                    updateResult("sequentialResult", "error", `Error: ${error.message}`);
                    window.testResults.sequential = { status: "error", message: error.message };
                }
            };
        </script>
    </body>
</html>
